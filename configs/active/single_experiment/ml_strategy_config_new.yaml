# ML Strategy Configuration with Box-Based Portfolio Construction
# ===============================================================
# This configuration demonstrates ML strategy setup with XGBoost model and Box-Based portfolio construction.
# Configured to match FF5 experiment settings for controlled variable comparison.
# Optimized for faster training while maintaining good performance.

# Part 1: Data Provider Configuration
# ---------------------------------
data_provider:
  type: "YFinanceProvider"
  parameters:
    max_retries: 3
    retry_delay: 1.0

# Part 2: Training Pipeline Configuration
# ------------------------------------
training_setup:
  model:
    model_type: "xgboost"  # Use XGBoost model for ML strategy
    config:
      # Optimized for faster training while maintaining good performance
      n_estimators: 100  # Reasonable default for speed/performance balance
      max_depth: 3  # Moderate depth to avoid overfitting
      learning_rate: 0.05  # Moderate learning rate
      subsample: 0.8  # Row sampling for regularization
      colsample_bytree: 0.8  # Column sampling for regularization
      early_stopping_rounds: 10
      random_state: 42
      
      # Regularization parameters for better generalization
      reg_alpha: 0.5  # L1 regularization (alpha)
      reg_lambda: 1.5  # L2 regularization (lambda)

  feature_engineering:
    enabled_features: ['momentum', 'volatility', 'technical', 'volume']
    momentum_periods: [21, 63, 252]
    volatility_windows: [20, 60]
    lookback_periods: [20, 60, 252]
    min_ic_threshold: 0.02
    min_significance: 0.1
    feature_lag: 1
    include_technical: true
    include_cross_sectional: true

    cross_sectional_features: [
      'market_cap',
      'book_to_market', 'size', 'value', 'momentum', 'volatility',
      'country_risk_premium', 'equity_risk_premium', 'default_spread', 'corporate_tax_rate'
    ]

    cross_sectional_lookback:
      momentum: 252
      volatility: 60
      ma_long: 200
      ma_short: 50
    winsorize_percentile: 0.01

    box_features:
      enabled: true
      size_categories: true
      style_categories: true
      region_categories: true
      sector_categories: true
      encoding_method: "one_hot"
      handle_unknown: "ignore"
  # Parameters for the training pipeline execution
  parameters:
    # Universe selection - same as FF5 for controlled comparison
    universe:
      source: "csv"
      csv_path: "./data/universes/complete_stock_data_converted.csv"
      filters:
        min_market_cap: 1000  # $1B (same unit as FF5)
        max_stocks: 200  # Reduced from 500 for faster training, but enough for box coverage
        # Ensure hard box coverage at input (uses CSV column `source_sheet`)
        include_boxes: ["DM_LG","DM_MG","DM_SG","DM_LV","DM_MV","DM_SV","EM_LG","EM_MG","EM_SG","EM_LV","EM_MV","EM_SV"]
        per_box_top_n: 15  # Reduced from 30 for faster training
        per_box_min_n: 1

    # Training period - same as FF5 for controlled comparison
    start_date: "2022-01-01"
    end_date: "2023-12-31"
    symbols: []

  # Hyperparameter optimization configuration
  # Disabled for faster training - use default model config for controlled comparison
  # Can enable later for model-specific optimization
  hyperparameter_optimization:
    enabled: false  # Disabled for faster training and controlled comparison with FF5
    optimization_method: "optuna"
    n_trials: 20  # Reduced for faster training if enabled
    cv_folds: 3
    objective: "sharpe_ratio"

    # Search space using XGBoost model defaults
    search_space_preset: "xgboost_default"

    # Optuna sampler and pruner settings
    sampler_type: "tpe"
    pruner_type: "median"

    # Logging
    log_to_wandb: true
    log_all_trials: true

# Part 3: Strategy Configuration
# ------------------------------
strategy:
  type: ml
  name: MLStrategy_v1

  parameters:
    model_id: "placeholder_model_id"  # Will be overwritten by orchestrator
    lookback_days: 252
    risk_free_rate: 0.02

  # Enable Box-Based portfolio construction
  # Same configuration as FF5 for controlled comparison
  portfolio_construction:
    method: "box_based"

    # Box construction parameters - same as FF5
    stocks_per_box: 3
    min_stocks_per_box: 3
    allocation_method: "mean_variance"  # Use mean-variance optimization for weight allocation (same as FF5)
    allocation_scope: "global"  # Use global mean-variance across all selected stocks (same as FF5)

    # Allocation configuration for mean-variance optimization - same as FF5
    allocation_config:
      risk_aversion: 2.0  # Risk aversion parameter (higher = more risk-averse)
      lookback_days: 252  # Lookback period for covariance estimation
      covariance_method: "ledoit_wolf"  # Options: "simple", "ledoit_wolf", or "factor_model"
      min_regression_obs: 24  # Minimum observations for factor model regression

    # Box weight configuration - equal weights for all boxes (same as FF5)
    box_weights:
      method: "equal"
      dimensions:
        size: ["large", "mid", "small"]
        style: ["growth", "neutral", "value"]  # Same as FF5 - includes neutral
        region: ["developed", "emerging"]
        sector: []

    # Stock classifier configuration - same as FF5
    classifier:
      method: "four_factor"
      cache_enabled: true

    # Box selector configuration - same as FF5
    box_selector:
      type: "signal_based"

  # Centralized constraints for both methods - same as FF5 for controlled comparison
  constraints:
    max_position_weight: 0.5
    max_leverage: 1.0
    min_position_weight: 0.01  # Select stocks by ML signal strength

    # Strategy-level controls - same as FF5 (no short selling for fair comparison)
    enable_short_selling: false

# Part 4: Backtesting Configuration
# --------------------------------
# Same backtest period and benchmark as FF5 for controlled comparison
backtest:
  name: "ML_Strategy_Backtest"
  start_date: "2024-07-01"  # Same as FF5
  end_date: "2025-08-15"  # Same as FF5
  initial_capital: 1000000
  
  # Benchmark configuration - same as FF5 (CSV file for WLS index)
  benchmark:
    source: "csv"
    csv_path: "./data/universes/wls_index.csv"
  
  commission_rate: 0.001
  slippage_rate: 0.0005
  rebalance_frequency: "weekly"
  position_limit: 0.99  # Same as FF5
  rebalance_threshold: 0.001

# Reporting and Analysis
# =====================
# Enhanced reporting for Box-Based analysis
reporting:
  generate_report: true
  output_directory: "./results/ml_strategy"

  # Box coverage analysis
  box_analysis:
    enabled: true
    track_box_coverage: true
    track_box_performance: true
    generate_box_charts: true

# Experiment Configuration
# =======================
experiment:
  name: "ML_Strategy_BoxBased_Comparison"
  description: "ML strategy with XGBoost model and Box-Based portfolio construction. Configured for controlled comparison with FF5 experiment."

  # Experiment tracking
  log_to_wandb: true
  wandb_project: "ml_strategy_experiments"
  tags:
    - "ml"
    - "xgboost"
    - "portfolio_construction"
    - "box_based"
    - "comparison"
    - "controlled_variables"