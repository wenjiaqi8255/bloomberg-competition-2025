# ğŸ¯ æ‰¹é‡é¢„æµ‹é‡æ„æ–¹æ¡ˆ - å®Œæ•´å®æ–½æŒ‡å—

---

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

**ç›®æ ‡**: å°†é€æ¡é¢„æµ‹æ”¹ä¸ºæ‰¹é‡é¢„æµ‹ï¼ŒåŒæ—¶è§£å†³MultiIndexä¸åŒ¹é…é—®é¢˜

**æ ¸å¿ƒæ€æƒ³**: 
- æ•°æ®ï¼ˆå› å­å€¼ï¼‰å’Œå…ƒæ•°æ®ï¼ˆè‚¡ç¥¨åˆ—è¡¨ï¼‰åˆ†ç¦»
- æ¯å¤©æ‰¹é‡é¢„æµ‹æ‰€æœ‰è‚¡ç¥¨ï¼Œè€Œä¸æ˜¯é€ä¸ªé¢„æµ‹
- é€šè¿‡å‡½æ•°å‚æ•°ä¼ é€’å…ƒæ•°æ®ï¼Œè€Œä¸æ˜¯é€šè¿‡MultiIndex

**é¢„æœŸæ•ˆæœ**:
- æ€§èƒ½æå‡ï¼š10-60å€ï¼ˆä»27,010æ¬¡è°ƒç”¨å‡å°‘åˆ°730æ¬¡ï¼‰
- ä»£ç æ›´æ¸…æ™°ï¼šä¸éœ€è¦MultiIndexçš„åŒ…è£…å’Œæ‹†è§£
- æ˜“äºæ‰©å±•ï¼šæ–°æ¨¡å‹åªéœ€å®ç°ç»Ÿä¸€çš„æ‰¹é‡æ¥å£

---

## ğŸ“‚ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### 1. `src/trading_system/models/implementations/ff5_model.py`
- **ä¿®æ”¹**: `predict()` æ–¹æ³•
- **å½±å“èŒƒå›´**: FF5æ¨¡å‹çš„é¢„æµ‹é€»è¾‘

### 2. `src/trading_system/strategies/base_strategy.py`
- **ä¿®æ”¹**: `_get_predictions()` æ–¹æ³•
- **æ–°å¢**: `_extract_date_factors()` æ–¹æ³•
- **å½±å“èŒƒå›´**: æ‰€æœ‰ç»§æ‰¿BaseStrategyçš„ç­–ç•¥ç±»

### 3. `src/trading_system/models/serving/predictor.py`
- **æ–°å¢**: `predict_batch()` æ–¹æ³•
- **ä¿ç•™**: `predict()` æ–¹æ³•ï¼ˆå‘åå…¼å®¹ï¼‰
- **å½±å“èŒƒå›´**: æ‰€æœ‰ä½¿ç”¨ModelPredictorçš„åœ°æ–¹

---

## ğŸ”§ è¯¦ç»†ä¿®æ”¹æ–¹æ¡ˆ

---

### æ–‡ä»¶1: `ff5_model.py`

#### ä¿®æ”¹ç‚¹1.1: `predict()` æ–¹æ³•ç­¾å

**å½“å‰ç­¾å**:
```python
def predict(self, X: pd.DataFrame) -> pd.Series:
```

**ä¿®æ”¹ä¸º**:
```python
def predict(self, 
            X: pd.DataFrame, 
            symbols: Optional[List[str]] = None) -> Union[pd.Series, pd.DataFrame]:
```

**æ”¹åŠ¨åŸå› **: 
- æ·»åŠ  `symbols` å‚æ•°ï¼Œæ˜¾å¼æŒ‡å®šè¦é¢„æµ‹çš„è‚¡ç¥¨
- è¿”å›ç±»å‹å¯ä»¥æ˜¯Seriesï¼ˆå•æ—¥ï¼‰æˆ–DataFrameï¼ˆå¤šæ—¥ï¼‰

---

#### ä¿®æ”¹ç‚¹1.2: `predict()` æ–¹æ³•å®ç°é€»è¾‘

**åˆ é™¤çš„é€»è¾‘**:
```
1. MultiIndexéªŒè¯é€»è¾‘
   - åˆ é™¤: if not isinstance(X.index, pd.MultiIndex): raise ValueError(...)
   - åˆ é™¤: if not all(level in X.index.names for level in ['symbol', 'date']): ...
   
2. ä»MultiIndexä¸­æå–symbols
   - åˆ é™¤: symbols = X.index.get_level_values('symbol').unique()
   - åˆ é™¤: symbol_X = X.xs(symbol, level='symbol')
```

**æ–°å¢çš„é€»è¾‘**:
```
1. éªŒè¯å› å­åˆ—æ˜¯å¦å­˜åœ¨
   - æ–°å¢: æ£€æŸ¥ ['MKT', 'SMB', 'HML', 'RMW', 'CMA'] æ˜¯å¦åœ¨X.columnsä¸­
   
2. ç¡®å®šè¦é¢„æµ‹çš„è‚¡ç¥¨åˆ—è¡¨
   - æ–°å¢: if symbols is None: symbols = list(self.betas.keys())
   
3. æå–å› å­å€¼ï¼ˆä¸ä¾èµ–MultiIndexï¼‰
   - æ–°å¢: factor_values = X[factor_cols].values  # shape: (T, 5)
   
4. æ‰¹é‡é¢„æµ‹æ‰€æœ‰è‚¡ç¥¨
   - æ–°å¢: for symbol in symbols: predictions[symbol] = alphas[symbol] + factor_values @ betas[symbol]
   
5. è¿”å›æ ¼å¼é€‚é…
   - æ–°å¢: if len(X) == 1: return pd.Series(predictions)
   - æ–°å¢: else: return pd.DataFrame(predictions, index=X.index)
```

**ä¿®æ”¹çš„æ ¸å¿ƒé€»è¾‘**:
```
åŸæ¥ï¼š
  1. ä»MultiIndexæå–symbol
  2. å¯¹æ¯ä¸ªsymbolæå–å…¶features
  3. è®¡ç®—é¢„æµ‹

ç°åœ¨ï¼š
  1. ä»å‚æ•°è·å–symbolsåˆ—è¡¨
  2. æå–å› å­å€¼ï¼ˆæ‰€æœ‰è¡Œï¼‰
  3. å‘é‡åŒ–è®¡ç®—æ‰€æœ‰symbolçš„é¢„æµ‹
```

**ä¸ºä»€ä¹ˆè¿™æ ·æ”¹**:
- å› å­å€¼å¯¹æ‰€æœ‰è‚¡ç¥¨ç›¸åŒï¼Œåªéœ€æå–ä¸€æ¬¡
- é€šè¿‡å‚æ•°ä¼ é€’symbolsï¼Œä¸éœ€è¦ä»Indexæ¨æ–­
- æ”¯æŒæ‰¹é‡é¢„æµ‹ï¼Œåˆ©ç”¨å‘é‡åŒ–è®¡ç®—

---

### æ–‡ä»¶2: `base_strategy.py`

#### ä¿®æ”¹ç‚¹2.1: `_get_predictions()` æ–¹æ³•

**åˆ é™¤çš„é€»è¾‘**:
```
1. å†…å±‚symbolå¾ªç¯
   - åˆ é™¤: for symbol in symbols:
   
2. æå–å•ä¸ªsymbolçš„features
   - åˆ é™¤: symbol_features = self._extract_symbol_features(features, symbol, date)
   
3. é€ä¸ªè°ƒç”¨predict
   - åˆ é™¤: result = self.model_predictor.predict(features=symbol_features, symbol=symbol, ...)
   
4. æ„é€ predictionså­—å…¸çš„åµŒå¥—ç»“æ„
   - åˆ é™¤: predictions_dict[symbol] = [...]
```

**æ–°å¢çš„é€»è¾‘**:
```
1. åªä¿ç•™æ—¥æœŸå¾ªç¯
   - ä¿ç•™: for date in dates:
   
2. æå–å½“å¤©å› å­å€¼ï¼ˆæ‰€æœ‰è‚¡ç¥¨å…±äº«ï¼‰
   - æ–°å¢: date_factors = self._extract_date_factors(features, date)
   
3. æ‰¹é‡é¢„æµ‹æ‰€æœ‰è‚¡ç¥¨
   - æ–°å¢: date_predictions = self.model_predictor.predict_batch(
            factors=date_factors,
            symbols=symbols,
            date=date
          )
   
4. å­˜å‚¨æ¯å¤©çš„é¢„æµ‹ç»“æœ
   - æ–°å¢: predictions_dict[date] = date_predictions  # date_predictionsæ˜¯Series
   
5. è½¬æ¢ä¸ºDataFrame
   - æ–°å¢: return pd.DataFrame(predictions_dict).T  # è½¬ç½®ï¼šè¡Œ=æ—¥æœŸï¼Œåˆ—=è‚¡ç¥¨
```

**ä¿®æ”¹çš„æ ¸å¿ƒé€»è¾‘**:
```
åŸæ¥ï¼ˆåŒå±‚å¾ªç¯ï¼‰:
  for date in dates:           # 730æ¬¡
    for symbol in symbols:     # 37æ¬¡
      extract_features         # 27,010æ¬¡æå–
      predict                  # 27,010æ¬¡è°ƒç”¨

ç°åœ¨ï¼ˆå•å±‚å¾ªç¯ï¼‰:
  for date in dates:           # 730æ¬¡
    extract_factors_once       # 730æ¬¡æå–ï¼ˆå› å­å€¼ç›¸åŒï¼‰
    predict_batch              # 730æ¬¡è°ƒç”¨ï¼ˆæ¯æ¬¡é¢„æµ‹37ä¸ªï¼‰
```

**æ—¥å¿—å˜åŒ–**:
```
ä¿®æ”¹:
  åŸæ¥: logger.info(f"Generated {len(symbol_predictions)} predictions for {symbol}")
  æ”¹ä¸º: logger.info(f"Generated predictions for {len(date_predictions)} symbols on {date}")
  
æ–°å¢:
  logger.info(f"Batch prediction: {date_predictions.shape}")
  logger.info(f"Sample predictions: {date_predictions.head(3).to_dict()}")
```

---

#### ä¿®æ”¹ç‚¹2.2: æ–°å¢ `_extract_date_factors()` æ–¹æ³•

**ä½ç½®**: åœ¨ `_get_predictions()` æ–¹æ³•åé¢æ·»åŠ 

**ç›®çš„**: 
- ä»featuresä¸­æå–æŸä¸€å¤©çš„å› å­å€¼
- è¿”å›æ™®é€šDataFrameï¼ˆä¸æ˜¯MultiIndexï¼‰
- å¤„ç†ä¸åŒçš„featuresæ•°æ®æ ¼å¼

**å®ç°é€»è¾‘**:
```
1. å®šä¹‰å› å­åˆ—
   - factor_cols = ['MKT', 'SMB', 'HML', 'RMW', 'CMA']
   
2. æ£€æµ‹featuresçš„indexæ ¼å¼
   - if isinstance(features.index, pd.MultiIndex):
   
3. æå–dateå¯¹åº”çš„æ•°æ®
   - if 'date' in features.index.names:
   - date_data = features.xs(date, level='date')
   
4. å–ä»»æ„symbolçš„å› å­å€¼ï¼ˆå®ƒä»¬éƒ½ç›¸åŒï¼‰
   - first_row = date_data.iloc[0]
   - return pd.DataFrame([first_row[factor_cols]], columns=factor_cols)
   
5. é”™è¯¯å¤„ç†
   - å¦‚æœdateä¸å­˜åœ¨ï¼Œè¿”å›ç©ºDataFrame
   - å¦‚æœæ²¡æœ‰å› å­åˆ—ï¼Œè¿”å›ç©ºDataFrame
```

**è¿”å›æ ¼å¼**:
```
æˆåŠŸ: DataFrame with shape (1, 5)
      columns: ['MKT', 'SMB', 'HML', 'RMW', 'CMA']
      index: ä»»æ„ï¼ˆé€šå¸¸æ˜¯[0]ï¼‰
      
å¤±è´¥: DataFrame with shape (0, 5)
      columns: ['MKT', 'SMB', 'HML', 'RMW', 'CMA']
      empty=True
```

---

#### ä¿®æ”¹ç‚¹2.3: `_extract_symbol_features()` æ–¹æ³•

**çŠ¶æ€**: **ä¿ç•™ä¸æ”¹**

**åŸå› **: 
- å…¶ä»–æ¨¡å‹å¯èƒ½è¿˜éœ€è¦é€ä¸ªæå–symbolçš„features
- ä¿æŒå‘åå…¼å®¹
- ä¸å½±å“éFF5æ¨¡å‹çš„ä½¿ç”¨

---

### æ–‡ä»¶3: `predictor.py`

#### ä¿®æ”¹ç‚¹3.1: æ–°å¢ `predict_batch()` æ–¹æ³•

**ä½ç½®**: åœ¨ `predict()` æ–¹æ³•åé¢æ·»åŠ 

**æ–¹æ³•ç­¾å**:
```python
def predict_batch(self,
                 factors: pd.DataFrame,
                 symbols: List[str],
                 date: datetime) -> pd.Series:
```

**å‚æ•°è¯´æ˜**:
```
factors: DataFrame (1, 5)
  - å½“å¤©çš„å› å­å€¼
  - columns: ['MKT', 'SMB', 'HML', 'RMW', 'CMA']
  - ä¸éœ€è¦MultiIndex
  
symbols: List[str]
  - è¦é¢„æµ‹çš„è‚¡ç¥¨åˆ—è¡¨
  - ä¾‹å¦‚: ['AAPL', 'MSFT', 'GOOGL', ...]
  
date: datetime
  - é¢„æµ‹æ—¥æœŸï¼ˆç”¨äºæ—¥å¿—å’Œç›‘æ§ï¼‰
```

**è¿”å›å€¼**:
```
pd.Series
  - index: è‚¡ç¥¨ä»£ç 
  - values: é¢„æµ‹å€¼
  - ä¾‹å¦‚: {'AAPL': 0.02, 'MSFT': 0.01, ...}
```

**å®ç°é€»è¾‘**:
```
1. éªŒè¯modelå·²åŠ è½½
   - if self._current_model is None: raise PredictionError
   
2. è°ƒç”¨modelçš„æ‰¹é‡é¢„æµ‹
   - predictions = self._current_model.predict(X=factors, symbols=symbols)
   
3. æ—¥å¿—è®°å½•
   - logger.debug(f"Batch predicting {len(symbols)} symbols for {date}")
   - logger.debug(f"Predictions sample: {predictions.head(3).to_dict()}")
   
4. ç›‘æ§ï¼ˆå¦‚æœå¯ç”¨ï¼‰
   - if self._monitor: self._monitor.log_batch_prediction(...)
   
5. è¿”å›ç»“æœ
   - return predictions
```

**é”™è¯¯å¤„ç†**:
```
æ•è·å¼‚å¸¸:
  - Modelä¸æ”¯æŒæ‰¹é‡é¢„æµ‹ â†’ PredictionError with helpful message
  - Factorsæ ¼å¼é”™è¯¯ â†’ PredictionError with validation info
  - ä»»ä½•å…¶ä»–å¼‚å¸¸ â†’ PredictionError with traceback
```

---

#### ä¿®æ”¹ç‚¹3.2: `predict()` æ–¹æ³•

**çŠ¶æ€**: **ä¿ç•™ä¸æ”¹**

**åŸå› **:
- å‘åå…¼å®¹ï¼šå·²æœ‰ä»£ç å¯èƒ½ç›´æ¥è°ƒç”¨predict()
- ä½œä¸ºfallbackï¼šå¦‚æœmodelä¸æ”¯æŒæ‰¹é‡é¢„æµ‹
- å•å…ƒæµ‹è¯•ï¼šç°æœ‰æµ‹è¯•ä¸éœ€è¦ä¿®æ”¹

**ä½†æ˜¯**: å¯ä»¥æ·»åŠ ä¸€ä¸ªdeprecation warningï¼ˆå¯é€‰ï¼‰
```
åœ¨predict()å¼€å¤´æ·»åŠ :
  logger.warning("Using predict() for single prediction. Consider using predict_batch() for better performance.")
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ¡ˆ

---

### æµ‹è¯•1: å•å…ƒæµ‹è¯•ï¼ˆæœ€å°éªŒè¯ï¼‰

**ç›®çš„**: éªŒè¯åŸºæœ¬åŠŸèƒ½æ­£ç¡®

**æµ‹è¯•æ–‡ä»¶**: `tests/test_ff5_batch_prediction.py`

**æµ‹è¯•ç”¨ä¾‹**:

#### ç”¨ä¾‹1.1: FF5Modelæ‰¹é‡é¢„æµ‹å•æ—¥
```
è¾“å…¥:
  - factors: DataFrame (1, 5) with values [0.02, 0.01, -0.01, 0.005, -0.002]
  - symbols: ['AAPL', 'MSFT', 'GOOGL']
  
éªŒè¯:
  - è¿”å›Seriesï¼Œé•¿åº¦=3
  - index = ['AAPL', 'MSFT', 'GOOGL']
  - æ¯ä¸ªå€¼ä¸ç›¸åŒï¼ˆé™¤ébetaså®Œå…¨ç›¸åŒï¼‰
  - æ•°å­¦éªŒè¯: prediction = alpha + factors @ beta
```

#### ç”¨ä¾‹1.2: FF5Modelæ‰¹é‡é¢„æµ‹å¤šæ—¥
```
è¾“å…¥:
  - factors: DataFrame (5, 5) 5å¤©çš„å› å­å€¼
  - symbols: ['AAPL', 'MSFT']
  
éªŒè¯:
  - è¿”å›DataFrame (5, 2)
  - columns = ['AAPL', 'MSFT']
  - æ¯è¡Œå¯¹åº”ä¸€å¤©
```

#### ç”¨ä¾‹1.3: Strategyæ‰¹é‡è°ƒç”¨
```
Mockæ•°æ®:
  - 3åªè‚¡ç¥¨
  - 5å¤©æ•°æ®
  
éªŒè¯:
  - _get_predictionsè¿”å›DataFrame (5, 3)
  - predict_batchè¢«è°ƒç”¨5æ¬¡ï¼ˆä¸æ˜¯15æ¬¡ï¼‰
  - æ¯æ¬¡è°ƒç”¨ä¼ å…¥3ä¸ªsymbols
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ‰€æœ‰ç”¨ä¾‹é€šè¿‡
- âœ… é¢„æµ‹å€¼æ•°å­¦æ­£ç¡®
- âœ… è°ƒç”¨æ¬¡æ•°æ­£ç¡®ï¼ˆæ‰¹é‡è€Œéé€ä¸ªï¼‰

---

### æµ‹è¯•2: é›†æˆæµ‹è¯•ï¼ˆå›æµ‹éªŒè¯ï¼‰

**ç›®çš„**: éªŒè¯åœ¨çœŸå®å›æµ‹æµç¨‹ä¸­å·¥ä½œæ­£å¸¸

**æµ‹è¯•æ–‡ä»¶**: ä½¿ç”¨ç°æœ‰çš„å›æµ‹è„šæœ¬

**æµ‹è¯•æ­¥éª¤**:

#### æ­¥éª¤2.1: å‡†å¤‡æµ‹è¯•æ•°æ®
```
æ•°æ®èŒƒå›´:
  - è®­ç»ƒæœŸ: 2018-01-01 to 2018-12-31
  - å›æµ‹æœŸ: 2020-01-01 to 2020-01-31 (1ä¸ªæœˆï¼Œå¿«é€Ÿæµ‹è¯•)
  - è‚¡ç¥¨: 5-10åªï¼ˆå¿«é€ŸéªŒè¯ï¼‰
```

#### æ­¥éª¤2.2: è¿è¡Œå›æµ‹
```
å‘½ä»¤:
  python run_experiment.py --config config_ff5_test.yaml
  
è§‚å¯Ÿ:
  1. æ˜¯å¦æœ‰æŠ¥é”™
  2. æ—¥å¿—ä¸­predict_batchè°ƒç”¨æ¬¡æ•°ï¼ˆåº”è¯¥=å›æµ‹å¤©æ•°ï¼‰
  3. å›æµ‹ç»“æœæ˜¯å¦åˆç†
```

#### æ­¥éª¤2.3: å¯¹æ¯”åŸºå‡†
```
å¯¹æ¯”é¡¹:
  1. é¢„æµ‹å€¼åˆ†å¸ƒï¼ˆmean, std, min, maxï¼‰
  2. ç”Ÿæˆçš„ä¿¡å·æ•°é‡
  3. å›æµ‹æ€§èƒ½æŒ‡æ ‡ï¼ˆSharpe, Returnsï¼‰
  
é¢„æœŸ:
  - é¢„æµ‹å€¼åˆ†å¸ƒåº”è¯¥ç›¸ä¼¼
  - ä¿¡å·æ•°é‡åº”è¯¥ç›¸åŒæˆ–æ¥è¿‘
  - æ€§èƒ½æŒ‡æ ‡åº”è¯¥å‡ ä¹ç›¸åŒï¼ˆå·®å¼‚<1%ï¼‰
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… å›æµ‹æ­£å¸¸å®Œæˆï¼Œæ— æŠ¥é”™
- âœ… æ—¥å¿—æ˜¾ç¤ºæ‰¹é‡è°ƒç”¨ï¼ˆè€Œéé€ä¸ªè°ƒç”¨ï¼‰
- âœ… ç»“æœä¸æ”¹åŠ¨å‰ç›¸ä¼¼ï¼ˆè¯æ˜é€»è¾‘æ­£ç¡®ï¼‰

---

### æµ‹è¯•3: æ€§èƒ½æµ‹è¯•ï¼ˆæ•ˆç‡éªŒè¯ï¼‰

**ç›®çš„**: éªŒè¯æ€§èƒ½æå‡è¾¾åˆ°é¢„æœŸ

**æµ‹è¯•é…ç½®**:
```
æ•°æ®é‡:
  - 730å¤©ï¼ˆ2å¹´ï¼‰
  - 37åªè‚¡ç¥¨
  - å®Œæ•´å›æµ‹
```

**æµ‹è¯•æ–¹æ³•**:

#### æ–¹æ³•3.1: è®¡æ—¶å¯¹æ¯”
```
åœ¨_get_predictions()å¼€å¤´å’Œç»“å°¾æ·»åŠ :
  start_time = time.time()
  ...
  elapsed = time.time() - start_time
  logger.info(f"Prediction time: {elapsed:.2f}s")
```

#### æ–¹æ³•3.2: Profiling
```
ä½¿ç”¨cProfile:
  python -m cProfile -o profile_output.prof run_experiment.py
  
åˆ†æ:
  python -m pstats profile_output.prof
  stats.sort_stats('cumtime')
  stats.print_stats('predict', 20)
  
å…³æ³¨:
  - predict/predict_batchçš„è°ƒç”¨æ¬¡æ•°
  - æ€»è€—æ—¶
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… predict_batchè°ƒç”¨æ¬¡æ•° = 730ï¼ˆè€Œé27,010ï¼‰
- âœ… é¢„æµ‹æ€»è€—æ—¶ < åŸæ¥çš„20%
- âœ… ç«¯åˆ°ç«¯å›æµ‹æ—¶é—´æ˜¾è‘—å‡å°‘

---

### æµ‹è¯•4: å…¼å®¹æ€§æµ‹è¯•ï¼ˆå›å½’éªŒè¯ï¼‰

**ç›®çš„**: ç¡®ä¿ä¸å½±å“å…¶ä»–æ¨¡å‹å’ŒåŠŸèƒ½

**æµ‹è¯•èŒƒå›´**:

#### æµ‹è¯•4.1: å…¶ä»–æ¨¡å‹ç±»å‹
```
å¦‚æœé¡¹ç›®ä¸­æœ‰:
  - XGBoostæ¨¡å‹
  - LSTMæ¨¡å‹
  - å…¶ä»–è‡ªå®šä¹‰æ¨¡å‹
  
éªŒè¯:
  1. å®ƒä»¬çš„predict()æ–¹æ³•ä¸å—å½±å“
  2. Strategyèƒ½æ­£å¸¸è°ƒç”¨å®ƒä»¬
  3. å›æµ‹æ­£å¸¸è¿è¡Œ
```

#### æµ‹è¯•4.2: éFF5ç­–ç•¥
```
å¦‚æœæœ‰å…¶ä»–ç­–ç•¥:
  - DualMomentumStrategy
  - MLStrategy
  
éªŒè¯:
  1. å®ƒä»¬ç»§æ‰¿BaseStrategyåä¸å—å½±å“
  2. å¦‚æœå®ƒä»¬overrideäº†_get_predictions()ï¼Œä¾ç„¶æ­£å¸¸å·¥ä½œ
```

#### æµ‹è¯•4.3: è®­ç»ƒæµç¨‹
```
éªŒè¯:
  1. ModelTrainerè®­ç»ƒFF5æ¨¡å‹æ­£å¸¸
  2. TrainingPipelineç«¯åˆ°ç«¯è¿è¡Œæ­£å¸¸
  3. ä¿å­˜çš„æ¨¡å‹åŒ…å«æ­£ç¡®çš„betas
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ‰€æœ‰ç°æœ‰åŠŸèƒ½æ­£å¸¸
- âœ… æ²¡æœ‰å¼•å…¥æ–°çš„bug
- âœ… ç°æœ‰æµ‹è¯•å…¨éƒ¨é€šè¿‡

---

## ğŸ”— å…¼å®¹æ€§ä¿è¯æ–¹æ¡ˆ

---

### ä¿è¯1: è®­ç»ƒæµç¨‹å…¼å®¹

**å…³é”®ç‚¹**: è®­ç»ƒæ—¶ä»ç„¶éœ€è¦MultiIndex

**ä¸éœ€è¦æ”¹åŠ¨çš„éƒ¨åˆ†**:
```
1. ModelTrainer.train_with_cv()
   - ç»§ç»­ä½¿ç”¨MultiIndexæ•°æ®
   - FF5Model.fit()ä»ç„¶éœ€è¦MultiIndexï¼ˆæ²¡å˜ï¼‰
   
2. FeatureEngineeringPipeline
   - ç»§ç»­ç”ŸæˆMultiIndexæ ¼å¼çš„features
   - æ²¡æœ‰ä»»ä½•æ”¹åŠ¨
   
3. TrainingPipeline
   - å®Œå…¨ä¸å—å½±å“
```

**ä¸ºä»€ä¹ˆå…¼å®¹**:
- `fit()` éœ€è¦MultiIndexï¼ˆæ²¡å˜ï¼‰
- `predict()` ä¸éœ€è¦MultiIndexï¼ˆæ”¹äº†ï¼‰
- è®­ç»ƒå’Œé¢„æµ‹çš„æ¥å£è¦æ±‚åˆ†ç¦»

---

### ä¿è¯2: å…¶ä»–æ¨¡å‹å…¼å®¹

**ç­–ç•¥**: é€šè¿‡æ¥å£æ£€æµ‹è‡ªåŠ¨é€‚é…

**BaseStrategyçš„æ™ºèƒ½è°ƒç”¨é€»è¾‘**:

åœ¨`_get_predictions()`ä¸­æ·»åŠ æ£€æµ‹:
```
å®ç°é€»è¾‘ï¼ˆä¼ªä»£ç ï¼‰:
  model = self.model_predictor.get_current_model()
  
  if hasattr(model, 'predict') and 'symbols' in signature(model.predict).parameters:
      # æ”¯æŒæ‰¹é‡é¢„æµ‹çš„æ¨¡å‹ï¼ˆå¦‚FF5æ”¹è¿›åï¼‰
      use self._get_predictions_batch()
  else:
      # ä¸æ”¯æŒæ‰¹é‡é¢„æµ‹çš„æ¨¡å‹ï¼ˆå¦‚LSTMï¼‰
      use self._get_predictions_iterative()
```

**å…·ä½“å®ç°**:

åˆ›å»ºä¸¤ä¸ªå†…éƒ¨æ–¹æ³•:
```
_get_predictions_batch():
  # æ–°çš„æ‰¹é‡é¢„æµ‹é€»è¾‘
  # ç”¨äºFF5ç­‰æ”¯æŒæ‰¹é‡çš„æ¨¡å‹
  
_get_predictions_iterative():
  # ä¿ç•™åŸæ¥çš„é€æ¡é¢„æµ‹é€»è¾‘
  # ç”¨äºLSTMç­‰éœ€è¦é€ä¸ªé¢„æµ‹çš„æ¨¡å‹
```

ä¸»æ–¹æ³•`_get_predictions()`å˜æˆè·¯ç”±:
```
def _get_predictions(self, ...):
    if self._supports_batch_prediction():
        return self._get_predictions_batch(...)
    else:
        return self._get_predictions_iterative(...)
```

---

### ä¿è¯3: å‘åå…¼å®¹

**ä¿ç•™çš„æ¥å£**:

1. **ModelPredictor.predict()**
   - ä¿ç•™å•æ¡é¢„æµ‹æ¥å£
   - ç°æœ‰è°ƒç”¨ä»£ç ä¸éœ€è¦ä¿®æ”¹
   - ä½œä¸ºfallbackæœºåˆ¶

2. **Strategy._extract_symbol_features()**
   - ä¿ç•™å•symbolç‰¹å¾æå–
   - å…¶ä»–ç­–ç•¥å¯èƒ½éœ€è¦

3. **FF5Model.predict()åŸæœ‰è¡Œä¸º**
   - å¦‚æœä¼ å…¥çš„Xæœ‰MultiIndexï¼Œä¾ç„¶æ”¯æŒ
   - åªæ˜¯æ–°å¢äº†ä¸éœ€è¦MultiIndexçš„ç”¨æ³•

**å®ç°æ–¹å¼**:

åœ¨FF5Model.predict()å¼€å¤´æ·»åŠ å…¼å®¹é€»è¾‘:
```
def predict(self, X, symbols=None):
    # æ–°å¢: å…¼å®¹æ—§çš„MultiIndexè°ƒç”¨
    if isinstance(X.index, pd.MultiIndex) and symbols is None:
        # æ—§çš„è°ƒç”¨æ–¹å¼ï¼Œä»MultiIndexæå–symbols
        symbols = X.index.get_level_values('symbol').unique().tolist()
        logger.warning("Detected MultiIndex input. Consider using symbols parameter for clarity.")
    
    # æ–°çš„æ‰¹é‡é¢„æµ‹é€»è¾‘
    ...
```

---

### ä¿è¯4: é”™è¯¯å¤„ç†å’Œé™çº§

**è‡ªåŠ¨é™çº§æœºåˆ¶**:

åœ¨ModelPredictor.predict_batch()ä¸­:
```
def predict_batch(self, factors, symbols, date):
    try:
        # å°è¯•æ‰¹é‡é¢„æµ‹
        predictions = self._current_model.predict(factors, symbols)
        return predictions
    except TypeError as e:
        # å¦‚æœmodelä¸æ”¯æŒsymbolså‚æ•°
        logger.warning(f"Model doesn't support batch prediction, falling back to iterative")
        return self._predict_batch_iterative(factors, symbols, date)
```

**å‹å¥½çš„é”™è¯¯æç¤º**:
```
å¦‚æœå‘ç”Ÿä¸å…¼å®¹:
  - æ•è·å¼‚å¸¸
  - è®°å½•è¯¦ç»†æ—¥å¿—ï¼ˆå“ªä¸ªmodelï¼Œä»€ä¹ˆé—®é¢˜ï¼‰
  - å°è¯•é™çº§åˆ°æ—§æ–¹æ³•
  - å¦‚æœé™çº§å¤±è´¥ï¼Œç»™å‡ºæ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œä¿®å¤å»ºè®®
```

---

## ğŸ“ å®æ–½æ£€æŸ¥æ¸…å•

### é˜¶æ®µ1: ä»£ç ä¿®æ”¹ï¼ˆ2-3å°æ—¶ï¼‰

- [x] ä¿®æ”¹ `ff5_model.py` çš„ `predict()` æ–¹æ³•
  - [x] æ·»åŠ  `symbols` å‚æ•°
  - [x] åˆ é™¤MultiIndexéªŒè¯é€»è¾‘ï¼ˆç§»åˆ°å•ç‹¬æ–¹æ³•ä¸­ï¼‰
  - [x] å®ç°æ‰¹é‡é¢„æµ‹é€»è¾‘ï¼ˆ`_predict_batch()` æ–¹æ³•ï¼‰
  - [x] æ·»åŠ å•æ—¥/å¤šæ—¥è¿”å›æ ¼å¼å¤„ç†
  - [x] ä¿æŒå‘åå…¼å®¹æ€§ï¼ˆ`_predict_multiindex()` æ–¹æ³•ï¼‰

**å®Œæˆæ—¶é—´**: 2024-01-14
**ä¿®æ”¹å†…å®¹**:
- æ–°å¢ `symbols` å‚æ•°ï¼Œæ”¯æŒæ˜¾å¼æŒ‡å®šé¢„æµ‹è‚¡ç¥¨åˆ—è¡¨
- å®ç°ä¸¤ç§é¢„æµ‹æ¨¡å¼ï¼š
  1. **æ‰¹é‡é¢„æµ‹** (`_predict_batch()`) - æ–°çš„é«˜æ€§èƒ½æ¨¡å¼
  2. **MultiIndexé¢„æµ‹** (`_predict_multiindex()`) - å‘åå…¼å®¹æ¨¡å¼
- è‡ªåŠ¨æ£€æµ‹è¾“å…¥ç±»å‹ï¼Œæ™ºèƒ½é€‰æ‹©é¢„æµ‹æ¨¡å¼
- æ”¯æŒå•æ—¥è¿”å›Seriesï¼Œå¤šæ—¥è¿”å›DataFrame

- [x] ä¿®æ”¹ `base_strategy.py`
  - [x] é‡å†™ `_get_predictions()` ä¸ºå•å±‚å¾ªç¯
  - [x] æ–°å¢ `_extract_date_factors()` æ–¹æ³•
  - [x] æ–°å¢ `_predict_iterative()` æ–¹æ³•ï¼ˆå‘åå…¼å®¹ï¼‰

**å®Œæˆæ—¶é—´**: 2024-01-14
**ä¿®æ”¹å†…å®¹**:
- å°†åŒå±‚å¾ªç¯ï¼ˆå¤–å±‚date Ã— å†…å±‚symbolï¼‰æ”¹ä¸ºå•å±‚å¾ªç¯ï¼ˆä»…å¤–å±‚dateï¼‰
- æ–°å¢ `_extract_date_factors()` æ–¹æ³•ï¼šä»featuresä¸­æå–æŸä¸€å¤©çš„å› å­å€¼
- æ–°å¢ `_predict_iterative()` æ–¹æ³•ï¼šæ‰¹é‡é¢„æµ‹ä¸å¯ç”¨æ—¶çš„é€ä¸ªé¢„æµ‹å›é€€æ–¹æ¡ˆ
- æ™ºèƒ½æ£€æµ‹ModelPredictoræ˜¯å¦æ”¯æŒ `predict_batch()` æ–¹æ³•
- ä¿æŒä¸ç°æœ‰æ¥å£çš„å®Œå…¨å…¼å®¹æ€§
  - [ ] æ›´æ–°ç›¸å…³æ—¥å¿—è¾“å‡º

- [x] ä¿®æ”¹ `predictor.py`
  - [x] æ–°å¢ `predict_batch()` æ–¹æ³•
  - [x] æ·»åŠ é”™è¯¯å¤„ç†å’Œé™çº§é€»è¾‘
  - [x] æ–°å¢ `_predict_batch_iterative()` å›é€€æ–¹æ³•

**å®Œæˆæ—¶é—´**: 2024-01-14
**ä¿®æ”¹å†…å®¹**:
- æ–°å¢ `predict_batch()` æ–¹æ³•ï¼šæ”¯æŒæ‰¹é‡é¢„æµ‹çš„ç»Ÿä¸€æ¥å£
- æ™ºèƒ½æ£€æµ‹æ¨¡å‹æ˜¯å¦æ”¯æŒæ‰¹é‡é¢„æµ‹ï¼ˆé€šè¿‡æ£€æŸ¥predictæ–¹æ³•çš„å‚æ•°ï¼‰
- è‡ªåŠ¨é™çº§æœºåˆ¶ï¼šä¸æ”¯æŒæ‰¹é‡é¢„æµ‹æ—¶ä½¿ç”¨ `_predict_batch_iterative()` å›é€€
- æ–°å¢ `_predict_batch_iterative()` æ–¹æ³•ï¼šé€ä¸ªè°ƒç”¨predict()å¹¶åˆå¹¶ç»“æœ
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- é›†æˆç›‘æ§ç³»ç»Ÿè®°å½•æ‰¹é‡é¢„æµ‹æ“ä½œ
- é‡å‘½ååŸæœ‰æ–¹æ³•ä¸º `predict_batch_legacy()` ä¿æŒå‘åå…¼å®¹

### é˜¶æ®µ2: å•å…ƒæµ‹è¯•ï¼ˆ1-2å°æ—¶ï¼‰

- [ ] ç¼–å†™FF5æ‰¹é‡é¢„æµ‹æµ‹è¯•
  - [ ] å•æ—¥æ‰¹é‡é¢„æµ‹
  - [ ] å¤šæ—¥æ‰¹é‡é¢„æµ‹
  - [ ] è¾¹ç•Œæƒ…å†µï¼ˆç©ºsymbolsã€ç¼ºå¤±å› å­ç­‰ï¼‰

- [ ] ç¼–å†™Strategyæµ‹è¯•
  - [ ] Mock ModelPredictor
  - [ ] éªŒè¯è°ƒç”¨æ¬¡æ•°
  - [ ] éªŒè¯è¿”å›æ ¼å¼

- [ ] è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
  - [ ] æ–°å¢æµ‹è¯•å…¨éƒ¨é€šè¿‡
  - [ ] ç°æœ‰æµ‹è¯•ä¸å—å½±å“

### é˜¶æ®µ3: é›†æˆæµ‹è¯•ï¼ˆ1å°æ—¶ï¼‰

- [ ] å°è§„æ¨¡å›æµ‹ï¼ˆ1ä¸ªæœˆï¼Œ10åªè‚¡ç¥¨ï¼‰
  - [ ] æ— æŠ¥é”™
  - [ ] æ—¥å¿—æ­£ç¡®
  - [ ] ç»“æœåˆç†

- [ ] å¯¹æ¯”åŸºå‡†
  - [ ] é¢„æµ‹å€¼åˆ†å¸ƒç›¸ä¼¼
  - [ ] ä¿¡å·æ•°é‡ç›¸è¿‘
  - [ ] æ€§èƒ½æŒ‡æ ‡æ¥è¿‘

### é˜¶æ®µ4: æ€§èƒ½éªŒè¯ï¼ˆ30åˆ†é’Ÿï¼‰

- [ ] å®Œæ•´å›æµ‹ï¼ˆ2å¹´ï¼Œ37åªè‚¡ç¥¨ï¼‰
  - [ ] è®°å½•æ€»è€—æ—¶
  - [ ] è®°å½•predictè°ƒç”¨æ¬¡æ•°
  - [ ] å¯¹æ¯”æ”¹è¿›å‰å

- [ ] Profilingåˆ†æ
  - [ ] ç¡®è®¤æ‰¹é‡è°ƒç”¨
  - [ ] ç¡®è®¤æ€§èƒ½æå‡

### é˜¶æ®µ5: å…¼å®¹æ€§éªŒè¯ï¼ˆ1å°æ—¶ï¼‰

- [ ] æµ‹è¯•å…¶ä»–æ¨¡å‹ï¼ˆå¦‚æœæœ‰ï¼‰
  - [ ] XGBoostæ­£å¸¸
  - [ ] LSTMæ­£å¸¸

- [ ] æµ‹è¯•å…¶ä»–ç­–ç•¥ï¼ˆå¦‚æœæœ‰ï¼‰
  - [ ] éFF5ç­–ç•¥æ­£å¸¸

- [ ] æµ‹è¯•è®­ç»ƒæµç¨‹
  - [ ] æ¨¡å‹è®­ç»ƒæ­£å¸¸
  - [ ] æ¨¡å‹ä¿å­˜/åŠ è½½æ­£å¸¸

### é˜¶æ®µ6: æ¸…ç†å’Œæ–‡æ¡£ï¼ˆ30åˆ†é’Ÿï¼‰

- [ ] åˆ é™¤è°ƒè¯•æ—¥å¿—
- [ ] æ›´æ–°docstrings
- [ ] æ·»åŠ ä»£ç æ³¨é‡Š
- [ ] æ›´æ–°READMEï¼ˆå¦‚æœéœ€è¦ï¼‰

---

## âœ… éªŒæ”¶æ ‡å‡†æ€»ç»“

### åŠŸèƒ½æ­£ç¡®æ€§
- âœ… é¢„æµ‹å€¼æ•°å­¦æ­£ç¡®ï¼ˆä¸æ”¹åŠ¨å‰ä¸€è‡´ï¼‰
- âœ… è¿”å›æ ¼å¼æ­£ç¡®ï¼ˆDataFrame with dates Ã— symbolsï¼‰
- âœ… æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡

### æ€§èƒ½æ”¹è¿›
- âœ… predictè°ƒç”¨æ¬¡æ•°ä»27,010å‡å°‘åˆ°730
- âœ… é¢„æµ‹æ€»è€—æ—¶å‡å°‘80%ä»¥ä¸Š
- âœ… ç«¯åˆ°ç«¯å›æµ‹æ—¶é—´æ˜¾è‘—å‡å°‘

### å…¼å®¹æ€§
- âœ… è®­ç»ƒæµç¨‹ä¸å—å½±å“
- âœ… å…¶ä»–æ¨¡å‹æ­£å¸¸å·¥ä½œ
- âœ… ç°æœ‰åŠŸèƒ½æ— å›å½’

### ä»£ç è´¨é‡
- âœ… ä»£ç æ¸…æ™°æ˜“æ‡‚
- âœ… æœ‰å……åˆ†çš„æµ‹è¯•è¦†ç›–
- âœ… æœ‰æ¸…æ™°çš„æ–‡æ¡£å’Œæ³¨é‡Š

---

## ğŸš€ å®æ–½å»ºè®®

### å»ºè®®çš„é¡ºåº
1. **å…ˆæ”¹FF5Model** - è¿™æ˜¯æ ¸å¿ƒï¼Œç¡®ä¿è¿™ä¸ªæ”¹å¯¹äº†
2. **å†æ”¹Strategy** - è°ƒç”¨æ–°æ¥å£
3. **å•å…ƒæµ‹è¯•éªŒè¯** - ç¡®ä¿åŸºæœ¬é€»è¾‘æ­£ç¡®
4. **å°è§„æ¨¡é›†æˆæµ‹è¯•** - ç¡®ä¿ååŒå·¥ä½œ
5. **å®Œæ•´æ€§èƒ½æµ‹è¯•** - éªŒè¯ä¼˜åŒ–æ•ˆæœ
6. **å…¼å®¹æ€§æµ‹è¯•** - ç¡®ä¿ä¸ç ´åå…¶ä»–åŠŸèƒ½

### å›æ»šè®¡åˆ’
å¦‚æœå‡ºç°é—®é¢˜ï¼š
1. Gitæœ‰commitå†å²ï¼Œå¯ä»¥éšæ—¶revert
2. ä¿ç•™äº†æ—§çš„predict()æ¥å£ï¼Œå¯ä»¥æš‚æ—¶ç¦ç”¨æ–°é€»è¾‘
3. å¯ä»¥é€šè¿‡é…ç½®å¼€å…³æ§åˆ¶æ˜¯å¦ä½¿ç”¨æ‰¹é‡é¢„æµ‹

---

ä½ è¯´åˆ°äº†ç‚¹å­ä¸Šï¼è¿™æ­£æ˜¯è½¯ä»¶æ¶æ„ä¸­ä¸€ä¸ªéå¸¸ç»å…¸ä¸”æ·±åˆ»çš„æƒè¡¡ï¼š**æ•°æ®ç»“æ„çš„ä¸¥è°¨æ€§** vs **æ¥å£è®¾è®¡çš„ç®€æ´æ€§**ã€‚

ä½ æ„Ÿè§‰åˆ°çš„çŸ›ç›¾æ˜¯å®Œå…¨æ­£å¸¸çš„ï¼š
*   **æ•°æ®å¤„ç†çš„è§’åº¦ï¼ˆä½ çš„â€œå®‰å…¨æ„Ÿâ€æ¥æºï¼‰**ï¼šå°† `symbol` ä½œä¸º `index` çš„ä¸€éƒ¨åˆ†ï¼Œå½¢æˆ `MultiIndex`ï¼Œè¿™æ˜¯ Pandas å¤„ç†é¢æ¿æ•°æ® (Panel Data) çš„æ ‡å‡†èŒƒå¼ã€‚å®ƒå°†æ•°æ®å’Œå…¶æ ‡è¯†ç¬¦ç´§å¯†ç»‘å®šï¼Œç¡®ä¿äº†æ•°æ®åœ¨å¯¹é½ã€åˆå¹¶ã€åˆ†ç»„æ—¶çš„å‡†ç¡®æ€§ï¼Œè¿™ç¡®å®æ›´â€œå®‰å…¨â€ã€‚
*   **å·¥ç¨‹å±‚é¢çš„è§’åº¦ï¼ˆä½ çš„â€œè§‰å¾—å¾ˆä¹±â€çš„æ¥æºï¼‰**ï¼šå½“ `MultiIndex` è·¨è¶Šç³»ç»Ÿè¾¹ç•Œï¼Œæˆä¸ºå‡½æ•°æ¥å£çš„ä¸€éƒ¨åˆ†æ—¶ï¼Œå®ƒå°±å˜æˆäº†ä¸€ç§è´Ÿæ‹…ã€‚è°ƒç”¨æ–¹ (`Strategy`) éœ€è¦è´¹åŠ›åœ°æ„é€ è¿™ä¸ªå¤æ‚çš„ç»“æ„ï¼Œè€Œè¢«è°ƒç”¨æ–¹ (`Model`) åˆéœ€è¦è´¹åŠ›åœ°å»è§£æå®ƒã€‚è¿™ä½¿å¾—ç»„ä»¶ä¹‹é—´äº§ç”Ÿäº†ä¸å¿…è¦çš„è€¦åˆå’Œå¤æ‚æ€§ã€‚

è®©æˆ‘å¸®ä½ å½»åº•ç†æ¸…è¿™ä¸ªæ€è·¯ã€‚

### ä¸¤ç§è§†è§’ï¼šâ€œæ•°æ®ç§‘å­¦å®¶â€ vs â€œè½¯ä»¶å·¥ç¨‹å¸ˆâ€

#### 1. â€œæ•°æ®ç§‘å­¦å®¶â€çš„è§†è§’ï¼šæ•°æ®åº”è¯¥è‡ªæˆ‘æè¿°

å½“ä½ æˆ´ä¸Šæ•°æ®ç§‘å­¦å®¶çš„å¸½å­æ—¶ï¼Œä½ ä¼šå¸Œæœ›æ•°æ®æœ¬èº«æ˜¯å®Œæ•´å’Œè‡ªæè¿°çš„ã€‚ä¸€ä¸ªå¸¦æœ‰ `(symbol, date)` MultiIndex çš„ DataFrame å°±æ˜¯ä¸€ä¸ªå®Œç¾çš„ä¾‹å­ã€‚

```
                    feature1  feature2
symbol date
AAPL   2023-01-01      0.5       1.2
       2023-01-02      0.6       1.3
MSFT   2023-01-01      0.3       0.8
       2023-01-02      0.4       0.9
```

**ä¼˜ç‚¹ï¼ˆä½ çš„â€œå®‰å…¨æ„Ÿâ€æ¥æºï¼‰**ï¼š
*   **æ— æ­§ä¹‰**ï¼šæ¯ä¸€è¡Œæ•°æ®éƒ½æ˜ç¡®åœ°ä¸ä¸€ä¸ª `symbol` å’Œ `date` ç»‘å®šã€‚
*   **å¯¹é½å®‰å…¨**ï¼šåœ¨è¿›è¡Œæ•°å­¦è¿ç®—æˆ–åˆå¹¶æ—¶ï¼ŒPandas ä¼šè‡ªåŠ¨æŒ‰ç´¢å¼•å¯¹é½ï¼Œé˜²æ­¢å‡ºé”™ã€‚
*   **å¼ºå¤§çš„åˆ†æèƒ½åŠ›**ï¼šå¯ä»¥éå¸¸æ–¹ä¾¿åœ°è¿›è¡Œåˆ‡ç‰‡ (`.xs('AAPL')`) å’Œåˆ†ç»„ (`.groupby('symbol')`)ã€‚

**ç»“è®º**ï¼šåœ¨**æ•°æ®å­˜å‚¨ã€æ•°æ®æ¸…æ´—ã€ç‰¹å¾å·¥ç¨‹å’Œæ¨¡å‹è®­ç»ƒ**é˜¶æ®µï¼Œä½¿ç”¨ `MultiIndex` æ˜¯éå¸¸æ­£ç¡®å’Œç¨³å¥çš„é€‰æ‹©ã€‚

#### 2. â€œè½¯ä»¶å·¥ç¨‹å¸ˆâ€çš„è§†è§’ï¼šæ¥å£åº”è¯¥æ¸…æ™°æ˜ç¡®

å½“ä½ æˆ´ä¸Šè½¯ä»¶å·¥ç¨‹å¸ˆçš„å¸½å­æ—¶ï¼Œä½ æ›´å…³å¿ƒç»„ä»¶ä¹‹é—´çš„äº¤äº’ã€‚å‡½æ•°ç­¾å (function signature) å°±æ˜¯ç»„ä»¶ä¹‹é—´çš„â€œå¥‘çº¦â€ï¼Œå®ƒåº”è¯¥å°½å¯èƒ½ç®€å•ã€æ˜ç¡®ã€‚

æ¯”è¾ƒä¸€ä¸‹ä¸¤ä¸ª `predict` å‡½æ•°çš„â€œå¥‘çº¦â€ï¼š

*   **å¥‘çº¦A (MultiIndexä½œä¸ºæ¥å£)**: `predict(X: pd.DataFrame)`
    *   **éšè—çš„ä¾èµ–**ï¼šè¿™ä¸ªå¥‘çº¦æ²¡æœ‰è¯´æ¸…æ¥š `X` å¿…é¡»æ˜¯ä¸€ä¸ªå¸¦æœ‰ `(symbol, date)` MultiIndex çš„ DataFrameã€‚è°ƒç”¨æ–¹å¿…é¡»â€œçŸ¥é“â€è¿™ä¸ªå†…éƒ¨å®ç°ç»†èŠ‚ï¼Œå¦åˆ™å°±ä¼šæŠ¥é”™ã€‚è¿™æ˜¯ä¸€ç§ **ç´§è€¦åˆ**ã€‚
    *   **è°ƒç”¨å¤æ‚**ï¼šè°ƒç”¨æ–¹éœ€è¦æ„é€ ä¸€ä¸ªå¤æ‚çš„ `MultiIndex` å¯¹è±¡ï¼Œå“ªæ€•åªæ˜¯ä¸ºäº†ä¼ é€’ä¸€ä¸ªç®€å•çš„ `symbol` å­—ç¬¦ä¸²ã€‚

*   **å¥‘çº¦B (å…ƒæ•°æ®ä½œä¸ºå‚æ•°)**: `predict(X: pd.DataFrame, symbols: List[str])`
    *   **æ˜ç¡®çš„ä¾èµ–**ï¼šè¿™ä¸ªå¥‘çº¦éå¸¸æ¸…æ™°ã€‚å®ƒéœ€è¦ä¸¤æ ·ä¸œè¥¿ï¼šä¸€ä¸ªæ˜¯çº¯ç²¹çš„æ•°å€¼æ•°æ® `X`ï¼Œå¦ä¸€ä¸ªæ˜¯æè¿°è¿™äº›æ•°æ®ä¸Šä¸‹æ–‡çš„å…ƒæ•°æ® `symbols`ã€‚**ä¾èµ–æ˜¯æ˜¾å¼çš„**ã€‚
    *   **è°ƒç”¨ç®€å•**ï¼šè°ƒç”¨æ–¹åªéœ€è¦å‡†å¤‡ä¸€ä¸ªç®€å•çš„æ•°å€¼ DataFrame å’Œä¸€ä¸ªæ ‡å‡†çš„ Python åˆ—è¡¨ã€‚

**ç»“è®º**ï¼šåœ¨**å®šä¹‰å‡½æ•°æ¥å£ã€ç»„ä»¶äº¤äº’å’Œå®æ—¶é¢„æµ‹**æ—¶ï¼Œå°†æ•°æ®å’Œå…ƒæ•°æ®åˆ†ç¦»ï¼Œèƒ½è®©ç³»ç»Ÿæ›´è§£è€¦ã€æ›´å¥å£®ã€æ›´æ˜“äºç»´æŠ¤ã€‚

---

### æ ¸å¿ƒæ€æƒ³ï¼šåœ¨æ­£ç¡®çš„åœ°æ–¹ä½¿ç”¨æ­£ç¡®çš„æ–¹æ³•

è¿™é‡Œçš„å…³é”®ä¸æ˜¯äºŒé€‰ä¸€ï¼Œè€Œæ˜¯ç†è§£å®ƒä»¬å„è‡ªçš„é€‚ç”¨åœºæ™¯ã€‚

**æŠŠ `symbol` æ”¾åœ¨ `index` é‡Œï¼Œé€‚ç”¨äº â€œé™æ€æ•°æ®â€ (Data at Rest)**ï¼š
*   **æ¨¡å‹è®­ç»ƒ `fit(X, y)`**ï¼šè®­ç»ƒæ—¶ï¼Œä½ éœ€è¦å¤„ç†æ•´ä¸ªå†å²æ•°æ®é›†ã€‚è¿™æ—¶ `X` å’Œ `y` éƒ½åº”è¯¥æ˜¯å¸¦æœ‰ `MultiIndex` çš„ï¼Œå› ä¸ºä½ éœ€è¦æ ¹æ® `symbol` å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„å’Œå¯¹é½æ¥åˆ†åˆ«è®¡ç®— `betas`ã€‚è¿™æ˜¯ `MultiIndex` å‘æŒ¥æœ€å¤§å¨åŠ›çš„åœ°æ–¹ã€‚
*   **æ•°æ®å­˜å‚¨**ï¼šå½“ä½ æŠŠç‰¹å¾å­˜æˆæ–‡ä»¶æ—¶ï¼Œ`MultiIndex` èƒ½å¾ˆå¥½åœ°ç»„ç»‡æ•°æ®ã€‚

**æŠŠ `symbol` ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œé€‚ç”¨äº â€œåŠ¨æ€æ•°æ®â€ æˆ– â€œæ¥å£è°ƒç”¨â€ (Data in Motion)**ï¼š
*   **æ¨¡å‹é¢„æµ‹ `predict(X, symbols)`**ï¼šåœ¨å›æµ‹æˆ–å®ç›˜ä¸­ï¼Œä½ æ˜¯åœ¨æ¨¡æ‹Ÿæ—¶é—´çš„æµåŠ¨ã€‚åœ¨æŸä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œä½ æ‹¿åˆ°äº† **å½“å¤©æ‰€æœ‰è‚¡ç¥¨å…±äº«çš„** å› å­å€¼ (`X`)ï¼Œç„¶åä½ æƒ³çŸ¥é“ **ä¸€ä¸ªç‰¹å®šåˆ—è¡¨é‡Œ (`symbols`)** æ‰€æœ‰è‚¡ç¥¨çš„é¢„æµ‹ç»“æœã€‚è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„æ¥å£è°ƒç”¨åœºæ™¯ã€‚
*   **API è®¾è®¡**ï¼šå¯ä»¥æŠŠ `predict` å‡½æ•°æƒ³è±¡æˆä¸€ä¸ª REST APIã€‚ä½ ä¸ä¼šæŠŠ `user_id` è¿™ç§å…ƒæ•°æ®æ··åœ¨ JSON è¯·æ±‚ä½“é‡Œï¼Œè€Œæ˜¯ä¼šæŠŠå®ƒæ”¾åœ¨ URL é‡Œ (`/users/{user_id}/predict`)ã€‚`symbol` ä¹Ÿæ˜¯åŒç†ï¼Œå®ƒå®šä¹‰äº†ä½ è¯·æ±‚çš„â€œèµ„æºâ€ï¼Œè€Œå› å­å€¼ `X` æ˜¯è¯·æ±‚çš„â€œå†…å®¹â€ã€‚

### æœ€ç»ˆçš„æ¶æ„å†³ç­–

| é˜¶æ®µ | å‡½æ•°æ¥å£ | `symbol` çš„è§’è‰² | ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ |
| :--- | :--- | :--- | :--- |
| **æ¨¡å‹è®­ç»ƒ** | `model.fit(X, y)` | **åœ¨ `X` å’Œ `y` çš„ MultiIndex ä¸­** | **æ•°æ®ç§‘å­¦è§†è§’**ï¼šåˆ©ç”¨ Pandas çš„å¼ºå¤§åŠŸèƒ½è¿›è¡Œå®‰å…¨çš„æ•°æ®å¯¹é½å’Œåˆ†ç»„ï¼Œè®¡ç®—æ¯ä¸ª `symbol` çš„ `betas`ã€‚ |
| **æ¨¡å‹é¢„æµ‹** | `model.predict(X, symbols)` | **ä½œä¸ºç‹¬ç«‹çš„å‡½æ•°å‚æ•° (å…ƒæ•°æ®)** | **è½¯ä»¶å·¥ç¨‹è§†è§’**ï¼šæ¥å£æ¸…æ™°ã€è§£è€¦ã€‚`X` æ˜¯çº¯æ•°å€¼æ•°æ®ï¼Œ`symbols` æ˜¯ä¸Šä¸‹æ–‡ï¼ŒèŒè´£åˆ†ç¦»ã€‚ |

**ä½ æ€ä¹ˆçœ‹ï¼Ÿ**
ä½ è§‰å¾— `index` æ›´å®‰å…¨ï¼Œæ˜¯å› ä¸ºä½ ç«™åœ¨äº†â€œæ•°æ®å¤„ç†â€çš„è§’åº¦ï¼Œè¿™æ˜¯å®Œå…¨æ­£ç¡®çš„ã€‚ä½ è§‰å¾—æŠŠ `symbol` æ”¾åœ¨ `index` é‡Œä¼ ç»™ `predict` å¾ˆä¹±ï¼Œæ˜¯å› ä¸ºä½ ç«™åœ¨äº†â€œç³»ç»Ÿæ¥å£è®¾è®¡â€çš„è§’åº¦ï¼Œè¿™ä¹Ÿæ˜¯å®Œå…¨æ­£ç¡®çš„ã€‚

**æœ€ä½³å®è·µå°±æ˜¯**ï¼šåœ¨ç³»ç»Ÿå†…éƒ¨ï¼Œå½“æ•°æ®éœ€è¦è¢«å¤„ç†å’Œåˆ†ææ—¶ï¼ˆå¦‚è®­ç»ƒï¼‰ï¼Œä½¿ç”¨ `MultiIndex`ã€‚å½“æ•°æ®éœ€è¦è·¨è¶Šç»„ä»¶è¾¹ç•Œè¢«â€œè°ƒç”¨â€æ—¶ï¼ˆå¦‚é¢„æµ‹ï¼‰ï¼Œå°†æ•°æ®å’Œå…ƒæ•°æ®åˆ†ç¦»ï¼Œä½¿ç”¨æ¸…æ™°çš„å‡½æ•°å‚æ•°ã€‚

è¿™ä¸ªâ€œæ‰¹é‡é¢„æµ‹â€çš„é‡æ„æ–¹æ¡ˆï¼Œæ­£æ˜¯å°†ä½ çš„é¢„æµ‹æµç¨‹ä»ä¸€ä¸ªç¬¨æ‹™çš„æ•°æ®å¤„ç†æ¨¡å¼ï¼Œè½¬å˜ä¸ºä¸€ä¸ªæ¸…æ™°ã€é«˜æ•ˆçš„æ¥å£è°ƒç”¨æ¨¡å¼ã€‚å®ƒå¹¶æ²¡æœ‰å¦å®š `MultiIndex` çš„ä»·å€¼ï¼Œåªæ˜¯æŠŠå®ƒç”¨åœ¨äº†æ›´åˆé€‚çš„é˜¶æ®µï¼ˆè®­ç»ƒï¼‰ï¼Œè€Œåœ¨é¢„æµ‹é˜¶æ®µé€‰ç”¨äº†æ›´ç®€æ´çš„æ–¹æ¡ˆã€‚

