# FF5回测负收益问题诊断报告

## 检查日期
2025-11-10

## 模型信息
- 模型ID: `ff5_regression_20251107_012512`
- 训练期: 2022-01-01 到 2023-12-31
- 回测期: 2024-07-01 到 2025-08-15
- 回测结果: -32.47%总收益, Sharpe: -0.08

---

## 检查1: Alpha分布分析

### 统计信息
- **总股票数量**: 250只
- **Alpha范围**: -0.156641 到 0.196704
- **Alpha平均值**: 0.009668 (0.97%)
- **Alpha中位数**: 0.008146 (0.81%)
- **Alpha标准差**: 0.028220

### 符号分布
- **正Alpha股票**: 163只 (65.2%)
- **负Alpha股票**: 87只 (34.8%)
- **零Alpha股票**: 0只 (0.0%)

### 关键发现
1. **信号强度弱**: 平均Alpha只有0.97%，大部分Alpha值很小
2. **负Alpha问题**: 34.8%的股票有负Alpha，在禁用做空的情况下会被过滤掉
3. **Top Alpha股票**: 
   - 最高Alpha: 688525.SS (0.196704, 19.67%)
   - 第二高: 3715.TW (0.132585, 13.26%)
   - 第三高: 9896.HK (0.100248, 10.02%)

### 问题
- Alpha值太小，直接使用Alpha作为信号可能不够强
- 很多高Alpha股票可能是亚洲股票，可能在回测时无法使用

---

## 检查2: 极端收益日分析

### 极端收益日统计
- **阈值**: ±5%
- **极端收益日数量**: 17个
- **收益分布**:
  - 平均日收益: -0.0108%
  - 收益标准差: 3.7024%
  - 最大单日收益: 45.62% (2024-12-19)
  - 最小单日收益: -42.47% (2024-12-20)
  - 收益偏度: -0.3725
  - **收益峰度: 95.2155** ⚠️ (正常值应该接近3，95表示有极端异常值)

### Top 5极端收益日
1. **2024-12-19**: +45.62% ⚠️
2. **2024-12-20**: -42.47% ⚠️
3. **2024-08-15**: -29.08% ⚠️
4. **2025-04-07**: -14.84%
5. **2024-07-16**: -12.59%

### 关键发现
1. **连续极端波动**: 2024-12-19和2024-12-20连续两天出现极端波动
   - 第一天: +45.62%
   - 第二天: -42.47%
   - 累积收益: +3.15%
   - 这可能是数据问题、价格错误、或组合构建问题

2. **异常高的峰度**: 收益峰度为95.2，远超正常值（3），说明有极端异常值

3. **收益分布异常**: 虽然平均日收益接近0，但标准差高达3.7%，说明波动极大

### 可能原因
- 数据质量问题（价格数据错误）
- 组合构建问题（权重计算错误）
- 极端持仓集中（单股权重过高）
- 缺失数据导致的计算错误

---

## 检查3: 股票重叠度分析 ⚠️ **最严重问题**

### 股票数量对比
- **训练期股票**: 250只
- **回测期股票**: 9,592只
- **重叠股票**: 66只 (26.4%)
- **仅在训练期**: 184只 (73.6%)
- **仅在回测期**: 9,526只

### 关键发现

#### 1. 重叠度极低
- 只有26.4%的训练期股票在回测期可用
- **73.6%的训练期股票（184只）在回测时无法使用**
- 这意味着模型训练时学习到的184只股票的Alpha信息完全无法利用

#### 2. 高Alpha股票无法使用 ⚠️ **关键问题**
**Top 10正Alpha股票中，大部分都在"仅在训练期"列表中，回测时无法使用！**

仅在训练期的Top Alpha股票：
- 688525.SS: Alpha = 0.196704 (19.67%) ⚠️
- 3715.TW: Alpha = 0.132585 (13.26%) ⚠️
- 9896.HK: Alpha = 0.100248 (10.02%) ⚠️
- 3778.T: Alpha = 0.083221 (8.32%) ⚠️
- NICL.JK: Alpha = 0.081879 (8.19%) ⚠️

这些高Alpha股票（主要是亚洲股票）在回测时无法使用，导致策略无法利用最强的信号！

#### 3. 重叠股票的Alpha质量
- 重叠股票Alpha平均值: 0.010185 (1.02%)
- 重叠股票正Alpha比例: 74.2%
- 仅在训练期股票Alpha平均值: 0.009483 (0.95%)
- 仅在训练期股票正Alpha比例: 62.0%

重叠股票的Alpha质量略好，但差异不大。

#### 4. Alpha显著性过滤影响
使用t_threshold=2.0时：
- 显著股票数: 8只 (3.2%)
- 平均|t|: 2.3548

这意味着在严格的显著性过滤下，只有8只股票可用，信号非常稀少。

---

## 根本原因分析

### 问题1: 股票重叠度低（最严重）
**影响**: 
- 模型训练时看到的184只高Alpha股票在回测时无法使用
- 包括Top 10中的大部分高Alpha股票
- 导致策略无法利用最强的信号

**原因**:
- 训练期和回测期使用了不同的股票列表
- 训练期可能使用了特定的股票列表（如亚洲股票）
- 回测期使用了更大的股票池（9,592只），但大部分股票模型没有训练过

### 问题2: 信号生成方式不当
**影响**:
- 直接使用Alpha值作为信号，但Alpha值很小（平均0.97%）
- 负Alpha股票被过滤，导致可用股票减少
- 信号强度弱，容易被噪声淹没

**原因**:
- FF5策略直接使用Alpha值，没有进行标准化或rank-based处理
- Alpha值本身是日收益率，很小是正常的，但直接使用可能不合适

### 问题3: 极端收益日
**影响**:
- 2024-12-19和2024-12-20的极端波动导致大幅亏损
- 收益分布异常（峰度95.2）

**可能原因**:
- 数据质量问题
- 组合构建问题（权重计算错误）
- 持仓过于集中
- 缺失数据导致的计算错误

### 问题4: 组合构建参数
**影响**:
- stocks_per_box: 3（每个box只有3只股票，过于集中）
- max_position_weight: 0.5（50%单股上限过高）
- 可能导致组合过于集中，风险过高

---

## 解决方案建议

### 方案1: 提高股票重叠度（最高优先级）⭐
1. **统一股票列表**: 确保训练期和回测期使用相同的股票列表
2. **检查配置**: 
   - 训练期: 检查`training_setup.parameters.universe`配置
   - 回测期: 检查`backtest`配置中的股票列表
3. **建议**: 训练期和回测期都使用`complete_stock_data_converted.csv`，并应用相同的过滤条件

### 方案2: 优化信号生成
1. **使用rank-based信号**: 不要直接用Alpha值，使用Alpha的排名
2. **Z-score标准化**: 对Alpha进行标准化处理
3. **预测收益**: 使用Alpha + 因子暴露 × 预期因子收益，而不是只用Alpha

### 方案3: 调整组合构建参数
1. **增加stocks_per_box**: 从3增加到5-10
2. **降低max_position_weight**: 从0.5降低到0.10-0.15
3. **增加min_stocks_per_box**: 确保每个box有足够的股票

### 方案4: 检查极端收益日
1. **检查数据质量**: 验证2024-12-19和2024-12-20的价格数据
2. **检查持仓**: 查看这两天的持仓和权重
3. **检查组合构建**: 验证权重计算是否正确

### 方案5: 调整Alpha显著性过滤
1. **降低t_threshold**: 从2.0降低到1.5
2. **使用软过滤**: 使用sigmoid_shrinkage而不是hard_threshold
3. **检查过滤效果**: 确保过滤后还有足够的股票可用

---

## 立即行动项

### 高优先级
1. ✅ **检查训练期和回测期的股票列表配置**
2. ✅ **统一股票列表，确保重叠度>80%**
3. ✅ **检查极端收益日（2024-12-19, 2024-12-20）的数据和持仓**

### 中优先级
4. ⚠️ **优化信号生成方式（rank-based或Z-score）**
5. ⚠️ **调整组合构建参数（增加stocks_per_box，降低max_position_weight）**
6. ⚠️ **调整Alpha显著性过滤参数**

### 低优先级
7. 📋 **检查数据质量**
8. 📋 **优化组合构建逻辑**

---

## 预期改进

如果实施上述方案，预期可以：
1. **提高股票重叠度到80%+**: 可以利用更多训练好的Alpha信号
2. **减少极端收益日**: 通过改善数据质量和组合构建
3. **提高信号质量**: 通过优化信号生成方式
4. **降低组合集中度**: 通过调整组合构建参数
5. **提高回测收益**: 从-32.47%改善到接近0%或正值

---

## 检查脚本

检查脚本已保存：
- `check_backtest_issues.py`: 基础检查
- `detailed_analysis.py`: 详细分析

运行方式：
```bash
poetry run python check_backtest_issues.py
poetry run python detailed_analysis.py
```


