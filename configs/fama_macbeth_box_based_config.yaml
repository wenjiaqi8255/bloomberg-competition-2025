# Fama-MacBeth + Box-Based Portfolio Construction Strategy Configuration
# ================================================================================
# This configuration implements a Fama-MacBeth cross-sectional asset pricing model
# combined with Box-First portfolio construction for systematic diversification.
#
# The approach:
# 1. Use Fama-MacBeth cross-sectional regressions to estimate risk premia
# 2. Calculate expected returns for all stocks using average coefficients
# 3. Apply Box-First portfolio construction for systematic diversification
# 4. Select top stocks within each style box based on Fama-MacBeth signals
#
# References:
# - Fama, E. F., & MacBeth, J. D. (1973). Risk, return, and equilibrium
# - Box-First portfolio construction for systematic diversification
# ================================================================================

# Part 1: Data Provider Configuration
# ---------------------------------
data_provider:
  type: "YFinanceProvider"
  parameters:
    max_retries: 3
    retry_delay: 1.0

# Part 2: Fama-MacBeth Model Training Pipeline
# -------------------------------------------
training_setup:
  model:
    model_type: "fama_macbeth"  # Use Fama-MacBeth cross-sectional regression
    config:
      regularization: "none"  # or "ridge" for regularized cross-sectional regression
      alpha: 1.0  # Ridge regularization parameter (if ridge is used)
      min_cross_section_size: 5  # Minimum stocks per cross-section
      newey_west_lags: null  # Auto-detect for Newey-West standard errors

  feature_engineering:
    # Focus on cross-sectional features for Fama-MacBeth
    momentum_periods: [21, 63, 252]
    volatility_windows: [20, 60]
    lookback_periods: [20, 60, 252]
    min_ic_threshold: 0.02
    min_significance: 0.1
    feature_lag: 1
    include_technical: false  # Disable for pure cross-sectional
    include_cross_sectional: true  # Enable cross-sectional features for Fama-MacBeth

    # Cross-sectional features for Fama-MacBeth regression
    cross_sectional_features: ['market_cap', 'book_to_market', 'size', 'value', 'momentum', 'volatility']
    cross_sectional_lookback:
      momentum: 252
      volatility: 60
      ma_long: 200
      ma_short: 50
    winsorize_percentile: 0.01

  # Parameters for the training pipeline execution
  parameters:
    start_date: "2018-01-01"
    end_date: "2019-12-31"
    symbols:
      # Technology (Large Growth)
      - AAPL
      - MSFT
      - GOOGL
      - META
      - NVDA
      # Technology (Mid/Large Value)
      - CSCO
      - IBM
      - INTC

      # Healthcare (Large Growth)
      - JNJ
      - UNH
      - PFE
      # Healthcare (Mid/Large Value)
      - ABT
      - TMO
      - DHR

      # Financials (Large Growth)
      - JPM
      - BAC
      - GS
      # Financials (Mid/Large Value)
      - WFC
      - MS
      - AXP

      # Consumer (Growth)
      - AMZN
      - TSLA
      - HD
      - MCD
      # Consumer (Value)
      - WMT
      - PG
      - KO
      - COST

      # Industrial
      - CAT
      - GE
      - HON
      - UPS

      # Energy
      - XOM
      - CVX
      - COP

      # Communication
      - VZ
      - DIS
      - NFLX

  # Hyperparameter optimization for Fama-MacBeth model
  hyperparameter_optimization:
    enabled: true
    optimization_method: "optuna"
    n_trials: 20  # Reduced for faster demo
    cv_folds: 3
    objective: "r2"
    search_space_preset: "fama_macbeth_default"
    sampler_type: "tpe"
    pruner_type: "median"
    log_to_wandb: true
    log_all_trials: true

# Part 3: Box-Based Portfolio Construction Backtest
# ------------------------------------------------
backtest:
  name: "FamaMacBeth_BoxBased_Backtest"
  start_date: "2020-01-01"
  end_date: "2023-12-31"
  initial_capital: 1000000
  benchmark_symbol: "SPY"
  commission_rate: 0.001
  slippage_rate: 0.0005
  rebalance_frequency: "weekly"
  position_limit: 0.08  # Reduced to 8% for better diversification
  rebalance_threshold: 0.001

# Fama-MacBeth Strategy Configuration
strategy:
  name: "FamaMacBeth_BoxBased_Strategy"
  type: "ml_strategy"  # Uses ML infrastructure for cross-sectional regression

  # Normalization settings
  enable_normalization: true  # Enable strategy-layer normalization
  normalization_method: "minmax"  # Use MinMax normalization for [0, 1] range

  parameters:
    model_id: "placeholder_model_id"  # Will be overwritten by orchestrator
    lookback_days: 252
    risk_free_rate: 0.02

    # Enable Box-Based portfolio construction
    portfolio_construction:
      method: "box_based"

      # Box construction parameters
      stocks_per_box: 2
      min_stocks_per_box: 1
      allocation_method: "signal_proportional"  # Use Fama-MacBeth signals for weight allocation

      # Box weight configuration - equal weights for all boxes
      box_weights:
        method: "equal"
        dimensions:
          size: ["large", "mid", "small"]
          style: ["growth", "value"]
          region: ["developed"]  # Focus on US developed markets
          sector: [
            "Technology", "Financials", "Healthcare",
            "Consumer Discretionary", "Consumer Staples",
            "Industrials", "Energy", "Communication Services",
            "Materials", "Utilities", "Real Estate"
          ]

      # Stock classifier configuration
      classifier:
        method: "four_factor"
        cache_enabled: true

      # Box selector configuration
      box_selector:
        type: "signal_based"  # Select stocks by Fama-MacBeth signal strength

    # Strategy-level controls
    enable_short_selling: false
    max_position_weight: 0.08  # Consistent with backtest position limit

# Part 4: Feature Engineering Configuration
# ---------------------------------------
feature_engineering:
  # Enable cross-sectional features (key for Fama-MacBeth)
  include_cross_sectional: true
  include_technical: false  # Focus on cross-sectional, not time-series
  include_theoretical: false

  # Cross-sectional features to compute
  cross_sectional_features:
    - "market_cap"        # Size factor (SMB proxy)
    - "book_to_market"    # Value factor (HML proxy)
    - "size"              # Log market cap
    - "value"             # Value indicator
    - "momentum"          # Momentum factor
    - "volatility"        # Risk measure

  # Lookback periods for cross-sectional features
  cross_sectional_lookback:
    momentum: 252      # 12-month momentum
    volatility: 60     # 60-day volatility
    ma_long: 200       # 200-day MA for value proxy
    ma_short: 50       # 50-day MA

  # Winsorization to handle outliers
  winsorize_percentile: 0.01  # Winsorize at 1st and 99th percentile

  # Feature preprocessing
  normalize_features: true
  normalization_method: "minmax"  # Min-max normalization to [0, 1] range for TradingSignal compatibility
  handle_missing: "forward_fill"

  # Feature validation
  min_ic_threshold: 0.02  # Minimum Information Coefficient
  min_significance: 0.10  # 10% significance level
  feature_lag: 1  # Use lagged features to avoid look-ahead bias

# Part 5: Model Configuration
# ---------------------------
model:
  model_type: "fama_macbeth"

  # Fama-MacBeth specific parameters
  params:
    regularization: "none"  # or "ridge" for regularized cross-sectional regression
    alpha: 1.0  # Ridge regularization parameter (if ridge is used)
    min_cross_section_size: 5  # Minimum stocks per cross-section
    newey_west_lags: null  # Auto-detect for Newey-West standard errors

  # Model training
  training:
    train_frequency: "monthly"  # Retrain monthly
    rolling_window: 36  # Use 36 months of data
    min_train_periods: 24  # Minimum 24 months to train
    walk_forward: true  # Walk-forward validation

  # Prediction
  prediction:
    method: "average_coefficients"  # Use time-series average of gammas
    confidence_interval: 0.95  # 95% confidence intervals

  # Model evaluation
  evaluation:
    metrics:
      - "information_coefficient"  # IC between predictions and returns
      - "sharpe_ratio"
      - "long_short_return"
      - "coefficient_significance"

    # Cross-validation
    cv_method: "time_series_split"
    cv_folds: 5

# Part 6: System Integration Configuration
# ---------------------------------------
system_integration:
  enabled: true

  # Use Modern System Orchestrator with portfolio construction
  modern_orchestrator:
    enabled: true
    portfolio_construction_method: "box_based"

    # Strategy combination (if using multiple strategies)
    meta_model:
      method: "weighted_average"
      config:
        normalize_weights: true

    # Multi-strategy allocation
    capital_allocation:
      method: "fixed_weights"
      weights:
        fama_macbeth_box_based: 1.0  # 100% allocation to Fama-MacBeth Box-Based strategy

# Part 7: Risk Management
# ----------------------
risk_management:
  # Box-level risk controls
  box_risk_limits:
    max_box_weight: 0.15  # Maximum 15% in any single box
    min_box_coverage: 0.6  # Minimum 60% of target boxes covered
    max_sector_concentration: 0.25  # Maximum 25% in any sector

  # Position-level controls
  position_limits:
    max_single_position: 0.08  # Maximum 8% in single stock
    min_position: 0.01  # Minimum 1% position size
    max_turnover: 0.5  # Maximum 50% annual turnover

  # Drawdown controls
  drawdown_control:
    max_portfolio_drawdown: 0.15  # Stop trading at 15% drawdown
    volatility_target: 0.12  # Target 12% annual volatility
    rebalance_on_volatility: true

# Part 8: Reporting and Analysis
# -----------------------------
reporting:
  generate_report: true
  output_directory: "./results/fama_macbeth_box_based"

  # Box coverage analysis
  box_analysis:
    enabled: true
    track_box_coverage: true
    track_box_performance: true
    generate_box_charts: true

  # Performance attribution
  attribution_analysis:
    enabled: true
    analyze_box_contributions: true
    analyze_factor_exposures: true

  # Model analysis
  model_analysis:
    track_fama_macbeth_coefficients: true
    analyze_coefficient_stability: true
    generate_model_plots: true

  # Fama-MacBeth specific analysis
  fama_macbeth_analysis:
    enabled: true
    track_coefficient_time_series: true
    analyze_cross_sectional_r_squared: true
    generate_coefficient_plots: true

# Part 9: Experiment Configuration
# --------------------------------
experiment:
  name: "FamaMacBeth_BoxBased_Portfolio_Construction"
  description: "Fama-MacBeth cross-sectional model with Box-First portfolio construction for systematic diversification"

  # Experiment tracking
  log_to_wandb: true
  wandb_project: "fama_macbeth_box_based_experiments"
  tags:
    - "fama_macbeth"
    - "box_based"
    - "portfolio_construction"
    - "cross_sectional"
    - "systematic_diversification"

  # Comparison with baseline
  comparison:
    enabled: true
    baseline_method: "quantitative"  # Compare with traditional optimization
    compare_metrics:
      - "sharpe_ratio"
      - "max_drawdown"
      - "information_ratio"
      - "box_coverage"
      - "concentration_risk"

# Part 10: Fama-MacBeth Hyperparameter Optimization
# ------------------------------------------------
fama_macbeth_hyperparameter_optimization:
  enabled: true
  optimization_method: "optuna"
  n_trials: 30
  cv_folds: 3
  objective: "r2"
  direction: "maximize"

  sampler:
    type: "tpe"
    seed: 42

  pruner:
    type: "median"
    n_startup_trials: 5
    n_warmup_steps: 3
    interval_steps: 1

  search_space:
    preset: "fama_macbeth_default"

    custom_space:
      regularization:
        type: "categorical"
        choices: ["none", "ridge", "lasso"]
      alpha:
        type: "float"
        low: 0.01
        high: 10.0
        log_scale: true
      min_cross_section_size:
        type: "int"
        low: 3
        high: 10

  # Feature analysis
  feature_analysis:
    enabled: true
    analyze_coefficient_significance: true
    calculate_feature_correlations: true
    coefficient_stability_analysis: true

  # Logging
  logging:
    log_optimization: true
    log_all_trials: true
    create_optimization_plot: true
    log_coefficients: true
    log_feature_analysis: true

  # Validation
  validation:
    out_of_sample_test: true
    time_series_split: true
    stability_check: true
    statistical_significance: true

# Part 11: Performance Benchmarks
# -------------------------------
benchmarks:
  primary: "SPY"
  secondary:
    - "QQQ"  # Nasdaq 100 (Growth bias)
    - "IWM"  # Russell 2000 (Small cap bias)
    - "AGG"  # Bonds (Risk-free proxy)

  # Factor model benchmarks
  factor_benchmarks:
    - "MTUM"  # Momentum
    - "QUAL"  # Quality
    - "VLUE"  # Value
    - "SIZE"  # Size
    - "USMV"  # Minimum volatility

# Part 12: Advanced Options
# -------------------------
advanced:
  # Parallel processing
  n_jobs: -1  # Use all cores

  # Caching
  cache_features: true
  cache_predictions: false

  # Debugging
  debug_mode: false
  save_intermediate_results: true

# Part 13: Usage Example
# ---------------------
# To run this strategy:
#
# 1. Train the model:
#    python run_experiment.py --config configs/fama_macbeth_box_based_config.yaml
#
# 2. The pipeline will:
#    - Calculate cross-sectional features for each date
#    - Convert to panel format (date, symbol)
#    - Run Fama-MacBeth regression to estimate risk premia
#    - Generate expected returns using average coefficients
#    - Apply Box-First portfolio construction for diversification
#    - Select top stocks within each style box
#
# 3. Expected Results:
#    - Book-to-Market: Positive gamma (value premium)
#    - Size: Negative gamma (small cap premium)
#    - Momentum: Positive gamma (momentum premium)
#    - Systematic diversification across style boxes
#    - Improved risk-adjusted returns through box-based construction
#