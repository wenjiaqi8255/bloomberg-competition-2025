# Prediction Configuration - Single Model
# ======================================
# Configuration for generating investment predictions from a single trained model.
# Supports FF5, ML, and other single-model strategies.

# Prediction settings
prediction:
  prediction_date: "2025-08-28"  # Date to make predictions for (use latest available factor data)
  
# Strategy configuration (determines which model type)
strategy:
  type: "fama_french_5"  # Options: 'fama_french_5', 'ml', 'meta'
  name: "FF5_Prediction_Strategy"

  # For single model strategies (ff5, ml)
  parameters:
    model_id: "ff5_regression_20251104_202303"  # ✅ 更新为实验使用的模型ID
    model_registry_path: "./models/"
    use_fitted_pipeline: true  # Use the fitted feature pipeline stored with the model
    lookback_days: 252
    risk_free_rate: 0.02  # ✅ 添加：无风险利率
    min_signal_strength: 0.0000000001
    enable_normalization: true
    normalization_method: "minmax"
    enable_short_selling: false
    
    # ✅ 添加：Alpha显著性过滤配置（与实验配置一致）
    alpha_significance:
      enabled: true
      t_threshold: 2.0  # t-statistic threshold (|t| >= 2.0 for significance)
      method: "hard_threshold"  # Options: "hard_threshold", "linear_shrinkage", "sigmoid_shrinkage"
      tstats_path: "./alpha_tstats.csv"  # Path to CSV with columns: symbol, t_alpha, p_value, r_squared

# Data configuration - reuse from MultiModelOrchestrator pattern
data_provider:
  type: "YFinanceProvider"
  parameters:
    max_retries: 3
    retry_delay: 1.0

factor_data_provider:
  type: "FF5DataProvider"
  parameters:
    data_frequency: "daily"
    cache_dir: "./cache/factors"

# Universe configuration
universe:
  source: "csv"
  csv_path: "./data/universes/complete_stock_data_converted.csv"
  filters:
    min_market_cap: 100  # 实验用1000，但预测可以保持100
    max_stocks: 500
    include_boxes: ["DM_LG","DM_MG","DM_SG","DM_LV","DM_MV","DM_SV","EM_LG","EM_MG","EM_SG","EM_LV","EM_MV","EM_SV"]
    per_box_top_n: 20
    per_box_min_n: 1
  symbols: []

# Portfolio construction - USE FACTORY PATTERN
portfolio_construction:
  method: "box_based"
  
  # Box-based configuration (if method: box_based)
  stocks_per_box: 3
  min_stocks_per_box: 3
  allocation_method: "mean_variance"  # Use mean-variance optimization
  allocation_scope: "global"  # ✅ 与实验配置一致：使用全局均值方差优化
  
  # Allocation configuration for mean-variance optimization
  allocation_config:
    risk_aversion: 2.0  # Risk aversion parameter (higher = more risk-averse)
    lookback_days: 252  # Lookback period for covariance estimation
    covariance_method: "ledoit_wolf"  # ✅ 与实验配置一致：使用Ledoit-Wolf方法
    min_regression_obs: 24  # Minimum observations for factor model regression

  # Box weight configuration
  box_weights:
    method: "equal"
    dimensions:
      size: ["large", "mid", "small"]
      style: ["growth", "neutral", "value"]  
      region: ["developed", "emerging"]
      sector: []  # Empty = 3D boxes (size x style x region)

  # Stock classifier configuration
  classifier:
    method: "four_factor"
    cache_enabled: true

  # Box selector configuration
  box_selector:
    type: "signal_based"  # ✅ 修改：改为与实验配置一致的 "signal_based"

# Risk constraints (top-level constraints for prediction)
# ✅ 修复：统一使用顶层constraints，删除portfolio_construction.constraints避免冲突
constraints:
  max_position_weight: 0.15  # Maximum weight for any single position
  min_position_weight: 0.02  # Minimum weight threshold
  max_leverage: 1.0  # Maximum total portfolio leverage
  max_portfolio_risk: 0.20  # Maximum portfolio volatility
  sector_diversification: true  # Enable sector diversification checks

# Output configuration
output:
  format: "detailed"  # Options: 'simple', 'detailed', 'comparison'
  include_risk_analysis: true
  include_sector_analysis: true
  include_box_analysis: true
  save_results: true
  output_path: "./prediction_results/"