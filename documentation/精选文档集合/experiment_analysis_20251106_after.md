# 2025年11月6日之后实验对比分析报告

## 概述

本报告分析了2025年11月6日之后进行的FF5 Box-Based策略实验，重点关注信号源（signal_source）配置对策略表现的影响。所有实验均使用Box-Based组合构建方法，使用相同的预训练模型，但在信号生成方式上进行了对比测试。

**核心发现**：
1. **11月10日实验**：使用`expected_return`作为信号源，总回报-106.41%，Sharpe比率-1.49
2. **11月11日实验**：使用`alpha`作为信号源，总回报-125.29%，Sharpe比率-1.54
3. **对比结论**：`expected_return`模式表现略优于`alpha`模式，但两者均出现严重负收益

## 实验列表

### 回测阶段实验（11月6日之后）

| 实验ID | 时间 | 使用的模型 | 信号源 | 总回报率 | 年化回报 | 最大回撤 | Sharpe比率 | Alpha | Beta |
|--------|------|------------|--------|----------|----------|----------|------------|-------|------|
| **8z1e62rn** | **2025-11-10 22:11:26** | ff5_regression_20251107_012512 | **expected_return** | **-106.41%** | NaN | **-106.38%** | **-1.49** | **-1.20** | **0.58** |
| **btngqx3g** | **2025-11-11 14:13:01** | ff5_regression_20251107_012512 | **alpha** | **-125.29%** | NaN | **-133.36%** | **-1.54** | **-1.44** | **-0.85** |

**注意**：
- 两个实验使用相同的预训练模型：`ff5_regression_20251107_012512`
- 两个实验使用相同的回测期间：2024-07-01 至 2025-08-15
- 两个实验使用相同的股票池：250只股票
- 两个实验使用相同的组合构建参数（Box-Based方法）

## 详细分析

### 1. 实验配置对比

#### 实验 8z1e62rn (Expected Return模式)

**配置特点**：
- **信号源**：`expected_return`（使用完整预期收益 E[R] = α + β @ factors）
- **信号方法**：`rank`（排名标准化）
- **Alpha显著性过滤**：
  - `enabled: true`
  - `rolling_tstats: true`
  - `t_threshold: 1.5`
  - `method: "sigmoid_shrinkage"`
- **组合构建**：
  - `stocks_per_box: 8`
  - `max_position_weight: 0.10`
  - `position_limit: 0.99`
- **协方差方法**：`ledoit_wolf`
- **风险厌恶系数**：2.0

**回测结果**：
- **总回报率**：-106.41%
- **最终组合价值**：-$18,838.34（负值！）
- **年化回报率**：NaN（无法计算）
- **最大回撤**：-106.38%
- **Sharpe比率**：-1.49
- **Sortino比率**：-0.68
- **Information Ratio**：-1.10
- **Alpha**：-1.20
- **Beta**：0.58（正Beta，与市场同向）
- **波动率**：120.07%
- **胜率**：59.26%
- **平均持仓数**：145.5只
- **持仓数量范围**：72-185只
- **平均持仓权重**：0.71%
- **最大持仓权重**：19.11%
- **组合周转率**：3.46%

**关键指标**：
- **Top贡献者**：
  - 6254.T: 3.90%
  - 688256.SS: 3.48%
  - 688041.SS: 2.63%
  - PLTR: 2.03%
  - OPFI: 1.60%
- **最差贡献者**：
  - 229640.KS: -0.78%
  - 073240.KS: -0.73%
  - 688331.SS: -0.63%
  - 003670.KS: -0.43%
  - MCAP.ST: -0.43%

#### 实验 btngqx3g (Alpha模式)

**配置特点**：
- **信号源**：`alpha`（仅使用截距项）
- **信号方法**：`rank`（排名标准化）
- **Alpha显著性过滤**：
  - `enabled: true`
  - `rolling_tstats: true`
  - `t_threshold: 1.5`
  - `method: "sigmoid_shrinkage"`
- **组合构建**：与实验8z1e62rn相同
- **协方差方法**：`ledoit_wolf`
- **风险厌恶系数**：2.0

**回测结果**：
- **总回报率**：-125.29%
- **最终组合价值**：-$252,884.22（负值！）
- **年化回报率**：NaN（无法计算）
- **最大回撤**：-133.36%
- **Sharpe比率**：-1.54
- **Sortino比率**：-1.06
- **Information Ratio**：-1.58
- **Alpha**：-1.44
- **Beta**：-0.85（负Beta，与市场反向）
- **波动率**：124.45%
- **胜率**：55.20%
- **平均持仓数**：149.3只
- **持仓数量范围**：91-188只
- **平均持仓权重**：0.69%
- **最大持仓权重**：20.38%
- **组合周转率**：1.90%

**关键指标**：
- **Top贡献者**：
  - 6254.T: 4.37%
  - 688256.SS: 2.75%
  - 2328.HK: 1.37%
  - OPFI: 1.18%
  - 688041.SS: 1.18%
- **最差贡献者**：
  - 688331.SS: -1.11%
  - 073240.KS: -0.75%
  - 229640.KS: -0.74%
  - MCAP.ST: -0.47%
  - 1514.TW: -0.42%

### 2. 信号源对比分析

#### Expected Return vs Alpha

| 指标 | Expected Return | Alpha | 差异 |
|------|----------------|-------|------|
| **总回报率** | -106.41% | -125.29% | **+18.88%**（expected_return更好） |
| **最大回撤** | -106.38% | -133.36% | **+26.98%**（expected_return更好） |
| **Sharpe比率** | -1.49 | -1.54 | **+0.05**（expected_return更好） |
| **Sortino比率** | -0.68 | -1.06 | **+0.38**（expected_return更好） |
| **Information Ratio** | -1.10 | -1.58 | **+0.48**（expected_return更好） |
| **Alpha** | -1.20 | -1.44 | **+0.24**（expected_return更好） |
| **Beta** | 0.58 | -0.85 | **+1.43**（expected_return与市场同向） |
| **波动率** | 120.07% | 124.45% | **-4.38%**（expected_return波动更小） |
| **胜率** | 59.26% | 55.20% | **+4.06%**（expected_return更高） |
| **平均持仓数** | 145.5 | 149.3 | -3.8（alpha持仓更多） |
| **最大持仓权重** | 19.11% | 20.38% | **-1.27%**（expected_return更分散） |
| **组合周转率** | 3.46% | 1.90% | **+1.56%**（expected_return换手更高） |

**关键发现**：
1. **Expected Return模式表现略优**：在所有主要指标上，expected_return模式都优于alpha模式
2. **Beta差异显著**：
   - Expected Return: Beta = 0.58（与市场同向，但暴露度较低）
   - Alpha: Beta = -0.85（与市场反向，异常）
3. **波动率差异**：Expected Return模式波动率略低（120.07% vs 124.45%）
4. **持仓集中度**：Expected Return模式最大持仓权重更低（19.11% vs 20.38%）
5. **换手率差异**：Expected Return模式换手率更高（3.46% vs 1.90%）

### 3. 问题诊断

#### 3.1 负收益的根本原因

两个实验都出现了严重的负收益，可能的原因包括：

1. **模型质量问题**：
   - 使用的模型`ff5_regression_20251107_012512`可能在回测期间表现不佳
   - 模型训练期间（2022-01-01至2023-12-31）与回测期间（2024-07-01至2025-08-15）存在时间差
   - 模型可能过拟合训练数据，在测试数据上泛化能力差

2. **信号质量问题**：
   - Alpha显著性过滤可能过于严格或过于宽松
   - `t_threshold: 1.5`可能保留了太多噪音信号
   - `sigmoid_shrinkage`方法可能没有有效过滤不显著的alpha

3. **组合构建问题**：
   - Box-Based方法可能在某些市场环境下表现不佳
   - 平均持仓数过多（145-149只），可能导致信号稀释
   - 最大持仓权重限制（10%）可能过于严格，限制了高Alpha股票的权重

4. **市场环境因素**：
   - 回测期间（2024-07-01至2025-08-15）可能处于不利的市场环境
   - 基准收益（WLS指数）为18.22%，但策略收益为负，说明策略表现显著低于基准

#### 3.2 Alpha模式的异常Beta

Alpha模式出现负Beta（-0.85）是异常现象，可能的原因：

1. **信号构建问题**：
   - 仅使用alpha（截距项）可能忽略了重要的因子暴露
   - Alpha本身可能包含了对因子暴露的错误估计
   - 负Beta可能表明策略在下跌市场中反而上涨（异常）

2. **组合构建问题**：
   - 负Beta可能表明组合构建逻辑存在问题
   - 可能选择了与市场反向的股票组合

3. **数据质量问题**：
   - 某些股票的数据可能存在异常
   - 计算Beta时使用的基准数据可能有问题

### 4. 与11月4-6日实验的对比

#### 4.1 成功实验（11月4日实验202645）

| 指标 | 11月4日实验202645 | 11月10日实验 | 11月11日实验 |
|------|------------------|-------------|-------------|
| **信号源** | Alpha（无expected_return选项） | Expected Return | Alpha |
| **总回报率** | **+40.42%** | -106.41% | -125.29% |
| **Sharpe比率** | **1.17** | -1.49 | -1.54 |
| **最大回撤** | -66.88% | -106.38% | -133.36% |
| **Beta** | 0.73 | 0.58 | -0.85 |
| **Alpha** | 1.14 | -1.20 | -1.44 |
| **平均持仓数** | 13.0 | 145.5 | 149.3 |
| **最大持仓权重** | 66.70% | 19.11% | 20.38% |
| **Alpha过滤** | hard_threshold, t=2.0 | sigmoid_shrinkage, t=1.5 | sigmoid_shrinkage, t=1.5 |
| **stocks_per_box** | 未使用Box方法 | 8 | 8 |
| **训练股票数** | 178 | 250 | 250 |

**关键差异**：
1. **持仓数量差异巨大**：
   - 11月4日：平均13只持仓（固定）
   - 11月10-11日：平均145-149只持仓
   - 持仓数量增加10倍以上，可能导致信号稀释

2. **Alpha过滤方法不同**：
   - 11月4日：`hard_threshold`，t=2.0（更严格）
   - 11月10-11日：`sigmoid_shrinkage`，t=1.5（更宽松）
   - 更宽松的过滤可能保留了更多噪音信号

3. **组合构建方法不同**：
   - 11月4日：可能未使用Box-Based方法，或使用不同的配置
   - 11月10-11日：使用Box-Based方法，每个box 8只股票

4. **训练股票数不同**：
   - 11月4日：178只股票
   - 11月10-11日：250只股票
   - 更多股票可能导致模型泛化能力下降

### 5. 代码变更历史（11月6日之后）

根据聊天记录，11月6日之后的主要代码变更包括：

#### 5.1 修复回测负收益问题（11月10日）

1. **统一股票列表**：
   - 修改`experiment_orchestrator.py`
   - 从pretrained model获取训练时使用的股票列表
   - 确保回测使用与训练期相同的股票（100%重叠）

2. **优化信号生成**：
   - 修改`fama_french_5.py`
   - 添加信号转换方法（rank-based和Z-score标准化）
   - 在配置中添加`signal_method: "rank"`参数

3. **调整组合构建参数**：
   - 修改`ff5_box_based_experiment.yaml`
   - `stocks_per_box: 3 → 8`（提高分散度）
   - `max_position_weight: 0.5 → 0.10`（降低单股风险）
   - `t_threshold: 2.0 → 1.5`（保留更多股票）

#### 5.2 添加信号源功能（11月10日）

1. **实现signal_source配置**：
   - 修改`fama_french_5.py`和`fama_french_3.py`
   - 添加`_get_predictions_from_alpha()`方法（原有逻辑）
   - 添加`_get_predictions_from_expected_return()`方法（新逻辑）
   - 支持在alpha和expected_return之间切换

2. **配置变更**：
   - 在配置文件中添加`signal_source`参数
   - 默认值：`expected_return`
   - 支持值：`'alpha'`或`'expected_return'`

#### 5.3 其他修复和优化

1. **修复预测配置问题**（11月10日）：
   - 将`min_history_days`从60降至30
   - 修复数据获取逻辑

2. **修复signal-strength为0问题**（11月10日）：
   - 修复BaseStrategy中日期查找逻辑
   - 修复MLStrategy中模型访问方式
   - 修复ModelPredictor独立预测模式

3. **优化CovarianceCache**（11月10日）：
   - 实现LRU缓存机制
   - 添加缓存统计和淘汰功能

4. **代码重构**（11月10日）：
   - 提取公共组件（ComponentFactory）
   - 创建权重工具（WeightUtils）
   - 重构约束应用逻辑（ConstraintApplier）
   - 拆分BoxBasedPortfolioBuilder（ClassificationService, StockSelectionService）

## 关键发现

### 1. 信号源选择的影响

**Expected Return模式 vs Alpha模式**：

| 方面 | Expected Return | Alpha | 结论 |
|------|----------------|-------|------|
| **理论优势** | 使用完整因子模型 E[R] = α + β @ factors | 仅使用截距项α | Expected Return理论上更完整 |
| **实际表现** | -106.41%回报，Sharpe -1.49 | -125.29%回报，Sharpe -1.54 | Expected Return略优但都失败 |
| **Beta特征** | 0.58（与市场同向） | -0.85（与市场反向，异常） | Expected Return更合理 |
| **波动率** | 120.07% | 124.45% | Expected Return波动更小 |
| **持仓集中度** | 最大权重19.11% | 最大权重20.38% | Expected Return更分散 |

**结论**：
- Expected Return模式在所有指标上都略优于Alpha模式
- 但两者都出现严重负收益，说明问题不在信号源选择
- 负Beta（Alpha模式）表明可能存在组合构建或数据问题

### 2. 与历史成功实验的对比

**11月4日实验202645 vs 11月10-11日实验**：

| 差异点 | 11月4日（成功） | 11月10-11日（失败） | 影响 |
|--------|----------------|---------------------|------|
| **平均持仓数** | 13只（固定） | 145-149只 | **持仓过多导致信号稀释** |
| **Alpha过滤** | hard_threshold, t=2.0 | sigmoid_shrinkage, t=1.5 | **过滤过松保留噪音** |
| **训练股票数** | 178只 | 250只 | **股票池过大可能过拟合** |
| **组合构建** | 可能未用Box方法 | Box-Based, 8只/box | **Box方法可能不适合** |
| **最大持仓权重** | 66.70% | 19.11-20.38% | **权重限制过严** |

**关键问题**：
1. **持仓数量过多**：145-149只持仓 vs 13只，信号被严重稀释
2. **Alpha过滤过松**：sigmoid_shrinkage + t=1.5 可能保留了太多噪音信号
3. **Box方法可能不适合**：Box-Based方法可能导致持仓过多

### 3. 负收益的可能原因

1. **模型质量问题**（最可能）：
   - 模型`ff5_regression_20251107_012512`可能在回测期间表现不佳
   - 训练期间与回测期间存在时间差，模型可能过时
   - 需要检查模型在回测期间的预测准确性

2. **信号质量问题**：
   - Alpha显著性过滤可能不够严格
   - `sigmoid_shrinkage`方法可能没有有效过滤噪音
   - 需要检查过滤后的信号质量

3. **组合构建问题**：
   - Box-Based方法可能导致持仓过多
   - 最大持仓权重限制（10%）可能过于严格
   - 需要检查组合构建逻辑

4. **市场环境因素**：
   - 回测期间可能处于不利的市场环境
   - 基准收益18.22%，但策略收益为负，说明策略表现显著低于基准

## 建议

### 1. ⭐ 减少持仓数量（最重要）

**问题**：平均持仓145-149只，信号被严重稀释

**建议**：
- 减少`stocks_per_box`从8降至3-5
- 或增加Alpha显著性过滤的严格程度（t_threshold从1.5升至2.0）
- 或使用`hard_threshold`方法替代`sigmoid_shrinkage`
- 目标：将平均持仓数降至20-30只

### 2. 收紧Alpha显著性过滤

**问题**：`sigmoid_shrinkage` + `t=1.5`可能保留了太多噪音信号

**建议**：
- 将`t_threshold`从1.5升至2.0（与11月4日成功实验一致）
- 或使用`hard_threshold`方法替代`sigmoid_shrinkage`
- 目标：只保留统计显著的alpha信号

### 3. 检查模型质量

**问题**：模型可能在回测期间表现不佳

**建议**：
- 检查模型`ff5_regression_20251107_012512`在回测期间的预测准确性
- 重新训练模型，使用更接近回测期间的数据
- 或使用11月4日成功实验使用的模型

### 4. 调整组合构建参数

**问题**：Box-Based方法可能导致持仓过多

**建议**：
- 减少`stocks_per_box`从8降至3-5
- 或增加`max_position_weight`从10%升至20-30%
- 或考虑不使用Box-Based方法，使用更简单的组合构建方法

### 5. 统一配置与历史成功实验

**问题**：配置与11月4日成功实验差异较大

**建议**：
- 使用与11月4日实验202645相同的配置：
  - `stocks_per_box: 3`（或更少）
  - `alpha_significance.method: "hard_threshold"`
  - `alpha_significance.t_threshold: 2.0`
  - 减少平均持仓数至20只以下

### 6. 继续使用Expected Return模式

**问题**：Alpha模式出现负Beta异常

**建议**：
- 优先使用`expected_return`模式（表现略优，Beta更合理）
- 如果必须使用alpha模式，需要检查负Beta的原因

## 结论

本次实验对比显示：

1. **Expected Return模式略优于Alpha模式**：
   - 在所有主要指标上都表现更好
   - Beta更合理（0.58 vs -0.85）
   - 波动率更低，持仓更分散

2. **但两者都出现严重负收益**：
   - 总回报率：-106.41%（expected_return）vs -125.29%（alpha）
   - Sharpe比率：-1.49 vs -1.54
   - 说明问题不在信号源选择，而在其他方面

3. **与历史成功实验的差异**：
   - 平均持仓数：145-149只 vs 13只（差异巨大）
   - Alpha过滤：sigmoid_shrinkage + t=1.5 vs hard_threshold + t=2.0
   - 训练股票数：250只 vs 178只

4. **主要问题**：
   - **持仓数量过多**：信号被严重稀释
   - **Alpha过滤过松**：保留了太多噪音信号
   - **模型质量**：可能在回测期间表现不佳

**最终建议**：
- ⭐ **减少持仓数量**（最重要）：将平均持仓数降至20-30只
- **收紧Alpha过滤**：使用hard_threshold + t=2.0
- **检查模型质量**：验证模型在回测期间的预测准确性
- **继续使用Expected Return模式**：表现略优，Beta更合理

---

**报告生成时间**：2025-11-11  
**实验日期**：2025-11-06 至 2025-11-11  
**配置文件**：`configs/active/single_experiment/ff5_box_based_experiment.yaml`  
**参考实验**：
- 11月4日实验202645（成功案例）
- 11月10日实验8z1e62rn（expected_return模式）
- 11月11日实验btngqx3g（alpha模式）


